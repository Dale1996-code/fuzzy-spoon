<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Walmart Academy Trainer Dashboard â€” Pro (v3)</title>
<link rel="stylesheet" href="./styles.css"/>
</head>
<body>
<div class="app-shell">
  <!-- HEADER (sticky command bar) -->
  <div class="header sticky" id="hdr">
    <div class="header-top">
      <div class="title-wrap">
        <h1>ğŸª Walmart Neighborhood Market</h1>
        <p class="subtitle">Salesfloor Academy Trainer Dashboard â€” Pro</p>
        <div class="muted mini-clock" id="live-clock">--:--</div>
      </div>
      <div class="header-actions">
        <div class="pill compact-pill">ğŸ“… <span id="current-date"></span></div>
        <div class="pill" id="health-pill" aria-live="polite">Health: <strong id="health-score">--</strong></div>
        <button class="btn btn-ghost pill-btn" id="themeBtn" aria-label="Toggle theme">ğŸŒ“ Theme</button>
        <button class="btn btn-primary" id="openExports">â¬‡ï¸ Exports</button>
      </div>
    </div>
    <div class="header-bottom">
      <div class="pill roster-pill">
        <label for="rosterInput">Shift Roster</label>
        <input id="rosterInput" placeholder="Add name and press Enter"/>
      </div>
      <div class="roles" id="shiftRoles">
        <div class="role-item"><label>Closing Trainer</label><select class="input-field role-select" data-role="closing"></select></div>
        <div class="role-item"><label>Freight Lead</label><select class="input-field role-select" data-role="freight"></select></div>
        <div class="role-item"><label>Zoning Lead</label><select class="input-field role-select" data-role="zoning"></select></div>
        <div class="role-item"><label>Fresh Lead</label><select class="input-field role-select" data-role="fresh"></select></div>
        <div class="role-item"><label>Runner / Utility</label><select class="input-field role-select" data-role="runner"></select></div>
      </div>
      <div class="timeline" id="shiftTimeline" aria-label="Shift timeline"></div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar-wrap">
    <div class="toolbar">
      <button class="btn btn-primary" id="saveBtn">ğŸ’¾ Save</button>
      <button class="btn btn-success" id="loadBtn">ğŸ“‚ Load</button>
      <button class="btn btn-warning" id="exportBtn">â¬‡ï¸ Export CSVs</button>
      <button class="btn btn-danger" id="clearBtn">ğŸ§¹ Clear</button>
      <button class="btn" id="printBtn">ğŸ–¨ï¸ Print / PDF</button>
      <button class="btn" id="settingsBtn">âš™ï¸ Dept Targets</button>
      <label class="btn">ğŸ“¥ Import Roster CSV <input type="file" id="importRoster" accept=".csv" style="display:none"/></label>
      <label class="btn">ğŸ“¥ Import Overstock CSV <input type="file" id="importOverstock" accept=".csv" style="display:none"/></label>
      <div class="pill compact-pill help-pill" id="openHelp" role="button" tabindex="0">â“ Shortcuts</div>
    </div>
    <div class="toolbar secondary-toolbar">
      <button class="btn" data-action="shift-roster">Shift Roster</button>
      <button class="btn" data-action="closing-trainer">Closing Trainer</button>
      <button class="btn" data-action="freight-lead">Freight Lead</button>
      <button class="btn" data-action="zoning-lead">Zoning Lead</button>
      <button class="btn" data-action="runner-utility">Runner/Utility</button>
      <button class="btn" data-action="calendar">Calendar</button>
      <button class="btn" data-action="health">Health</button>
    </div>
  </div>

  <!-- Layout -->
  <div class="content-shell">
    <aside class="side-nav">
      <div class="nav-header">
        <span class="nav-title">Workspace</span>
        <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation" aria-expanded="false">â˜° Menu</button>
      </div>
      <div class="tabs" id="tabNav" role="tablist">
        <div class="tab active" data-tab="dashboard" role="tab" tabindex="0" aria-selected="true">ğŸ“Š Daily Dashboard</div>
        <div class="tab" data-tab="coaching" role="tab" tabindex="0" aria-selected="false">ğŸ‘¥ Coaching Tracker</div>
        <div class="tab" data-tab="reports" role="tab" tabindex="0" aria-selected="false">ğŸ“ˆ Reports</div>
      </div>
      <nav class="quick-links" aria-label="Quick section links">
        <a href="#freight" class="quick-link">ğŸ“¦ Freight</a>
        <a href="#team-summary" class="quick-link">ğŸ‘¥ Team Summary</a>
        <a href="#zones" class="quick-link">ğŸª Zones</a>
        <a href="#fresh" class="quick-link">ğŸ¥¬ Fresh Tours</a>
        <a href="#topstock" class="quick-link">ğŸ—‚ï¸ Top-Stock</a>
        <a href="#overstock" class="quick-link">ğŸ“‹ Overstock</a>
        <a href="#coaching" class="quick-link">ğŸ“ Coaching</a>
      </nav>
    </aside>

    <main class="main-area">
<div class="wrap">
  <!-- DASHBOARD -->
  <div id="dashboard" class="tab-content active">
    <details class="group live" data-group="live" open>
      <summary>Live Operations <span class="group-status" id="group-live-status">Monitoringâ€¦</span></summary>
      <div class="dashboard-container">
        <div class="section" id="freight">
          <div class="section-header"><span>ğŸ“¦</span><h2>Freight Performance Tracker</h2><div class="module-status" id="status-freight"></div></div>
          <div class="insight" id="insight-freight">Insights load here.</div>
          <div class="muted" style="margin-bottom:6px">Uses <strong>department targets</strong> if set; otherwise global target (<span id="kpi-target-cph">45</span>).</div>
          <div class="table-scroll">
            <table id="freight-table">
              <thead><tr><th>Select</th><th>Associate</th><th>Department</th><th>Clock In</th><th>Clock Out</th><th>Cases</th><th>Hours</th><th>Cases/Hr</th><th>Assigned</th><th>Status</th><th class="right">â‹¯</th></tr></thead>
              <tbody id="freight-tbody"></tbody>
            </table>
          </div>
          <div class="bulk-toolbar hidden" id="freight-bulk">
            <span>Bulk:</span>
            <button class="btn btn-success" data-bulk="assign-freight">Assign To</button>
            <button class="btn btn-primary" data-bulk="clockin">Clock In Now</button>
          </div>
          <div class="right" style="margin-top:6px"><button class="btn btn-primary" id="addFreightBtn">ï¼‹ Add Row</button></div>
          <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-value" id="kpi-total-cases">0</div><div class="kpi-label">Total Cases</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpi-total-hours">0.0</div><div class="kpi-label">Total Hours</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpi-avg-cph">0.0</div><div class="kpi-label">Avg Cases/Hr</div></div>
          </div>
          <div class="section" style="margin-top:10px">
            <div class="section-header" style="border-bottom:none"><span>âš™ï¸</span><h2 style="border:0">Department Targets (CPH)</h2></div>
            <div id="dept-targets" class="modal-grid"></div>
          </div>
          <div class="section" style="margin-top:10px" id="team-summary-card">
            <div class="section-header"><span>ğŸ“¢</span><h2>Team Summary</h2></div>
            <div class="muted" id="team-summary" style="padding:6px 0">Enter data to see team performance</div>
          </div>
        </div>

        <div class="section" id="zones">
          <div class="section-header"><span>ğŸª</span><h2>Zone Verification Status</h2><div class="module-status" id="status-zones"></div></div>
          <div class="insight" id="insight-zones">Insights load here.</div>
          <div class="table-scroll">
            <table id="zone-table">
              <thead><tr><th>Select</th><th>Zone</th><th>Total Aisles</th><th>Completed</th><th>% Complete</th><th>Assigned To</th><th>Status</th><th>History</th></tr></thead>
              <tbody id="zone-tbody"></tbody>
            </table>
          </div>
          <div class="bulk-toolbar hidden" id="zones-bulk">
            <span>Bulk:</span>
            <button class="btn btn-success" data-bulk="zone-complete">Mark Verified</button>
            <button class="btn btn-primary" data-bulk="zone-assign">Assign To</button>
          </div>
          <div class="progress-bar"><div class="progress-fill" id="zone-progress" style="width:0%">0% Complete</div></div>
        </div>

        <div class="section full-width" id="fresh">
          <div class="section-header"><span>ğŸ¥¬</span><h2>Fresh Area Tour Schedule</h2><div class="module-status" id="status-fresh"></div></div>
          <div class="insight" id="insight-fresh">Insights load here.</div>
          <div class="table-scroll">
            <table id="tours-table">
              <thead><tr><th>Select</th><th>Time Slot</th><th>Target Time</th><th>Actual Time</th><th>Assigned</th><th>Countdown</th><th>Produce</th><th>Meat</th><th>Deli</th><th>Bakery</th><th>Dairy</th><th>Frozen</th><th>Temp Check</th><th>Status</th><th>History</th></tr></thead>
              <tbody id="tours-tbody"></tbody>
            </table>
          </div>
          <div class="right" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
            <button class="btn" id="markFreshComplete">Mark All Fresh Areas Complete</button>
            <button class="btn btn-warning" id="clockInFresh">Clock In Now</button>
          </div>
        </div>
      </div>
    </details>

    <details class="group compliance" data-group="compliance">
      <summary>Compliance &amp; Prevention <span class="group-status" id="group-compliance-status">Monitoringâ€¦</span></summary>
      <div class="dashboard-container">
        <div class="section" id="topstock">
          <div class="section-header"><span>ğŸ—‚ï¸</span><h2>Top-Stock A/B Aisles Compliance (30 aisles)</h2><div class="module-status" id="status-topstock"></div></div>
          <div class="insight" id="insight-topstock">Insights load here.</div>
          <div class="muted">Quick pass: A1â€“A20 (Dry Grocery), B1â€“B10 (Consumables).</div>
          <div class="progress-bar"><div class="progress-fill" id="topstock-progress" style="width:0%">0% Verified</div></div>
          <div id="topstock-grid" class="topstock-grid"></div>
          <div class="right" style="margin-top:6px">
            <button class="btn btn-success" id="markTopstockAll">Mark All Verified</button>
            <button class="btn btn-warning" id="clearTopstockAll">Clear All</button>
            <button class="btn btn-primary" id="exportTopstock">Export Top-Stock CSV</button>
          </div>
        </div>

        <div class="section" id="overstock">
          <div class="section-header"><span>ğŸ“‹</span><h2>Overstock & Inventory Log</h2><div class="module-status" id="status-overstock"></div></div>
          <div class="insight" id="insight-overstock">Insights load here.</div>
          <div class="table-scroll">
            <table id="overstock-table">
              <thead><tr><th>Select</th><th>Location</th><th>Item/UPC</th><th>Qty</th><th>Action</th><th>Assigned</th><th>Status</th><th class="right">â‹¯</th></tr></thead>
              <tbody id="overstock-tbody"></tbody>
            </table>
          </div>
          <div class="bulk-toolbar hidden" id="overstock-bulk">
            <span>Bulk:</span>
            <button class="btn btn-success" data-bulk="overstock-complete">Resolve</button>
            <button class="btn btn-primary" data-bulk="overstock-assign">Assign To</button>
          </div>
          <div class="right" style="margin-top:6px"><button class="btn btn-primary" id="addOverstockBtn">ï¼‹ Add Item</button></div>
        </div>
      </div>
    </details>

    <details class="group people" data-group="people">
      <summary>People &amp; Development <span class="group-status" id="group-people-status">Monitoringâ€¦</span></summary>
      <div class="dashboard-container" style="grid-template-columns:1fr 1fr;">
        <div class="section coaching-form" id="coaching-embedded">
          <div class="section-header"><span>ğŸ“</span><h2>Coaching Tracker</h2><div class="module-status" id="status-coaching"></div></div>
          <div class="insight" id="insight-coaching">Insights load here.</div>
          <!-- form duplicated below for tab reuse -->
          <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px">
            <div class="form-group"><label>Associate Name</label><input class="input-field" id="coach-assoc" placeholder="Full name"/></div>
            <div class="form-group"><label>Department</label>
              <select class="input-field" id="coach-dept">
                <option>Dry Grocery</option><option>Consumables</option><option>Produce</option>
                <option>Meat</option><option>Deli/Bakery</option><option>Dairy</option><option>Frozen</option>
              </select>
            </div>
          </div>
          <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px">
            <div class="form-group">
              <label>Issues</label>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:6px 0">
                <label><input type="checkbox" class="checkbox coach-issue" value="Attendance"/> Attendance</label>
                <label><input type="checkbox" class="checkbox coach-issue" value="Productivity"/> Productivity</label>
                <label><input type="checkbox" class="checkbox coach-issue" value="Zoning"/> Zoning</label>
                <label><input type="checkbox" class="checkbox coach-issue" value="Backroom/Top-Stock"/> Backroom/Top-Stock</label>
                <label><input type="checkbox" class="checkbox coach-issue" value="Fresh Area Compliance"/> Fresh Area Compliance</label>
                <label><input type="checkbox" class="checkbox coach-issue" value="Other"/> Other</label>
              </div>
            </div>
            <div class="form-group"><label>Follow-up Date</label><input class="input-field" type="date" id="coach-follow"/></div>
          </div>
          <div class="form-group"><label>Goals</label><textarea class="input-field" id="coach-goals" rows="3" placeholder="Specific, measurable goals..."></textarea></div>
          <div class="form-group"><label>Notes</label><textarea class="input-field" id="coach-notes" rows="3" placeholder="Observations, expectations, support..."></textarea></div>
          <div class="right">
            <button class="btn btn-success" id="saveCoachingBtn">Save Entry</button>
            <button class="btn btn-primary" id="exportCoachingBtn">Export CSV</button>
            <button class="btn btn-warning" id="clearCoachingBtn">Clear Saved</button>
          </div>
          <div class="section" style="margin-top:10px">
            <div class="section-header" style="border-bottom:none"><span>ğŸ“¦</span><h2 style="border:0">Saved Items</h2></div>
            <div id="coaching-list" style="margin-top:6px"></div>
          </div>
        </div>
        <div class="section" id="saved-items">
          <div class="section-header"><span>ğŸ’¾</span><h2>Saved Items & History</h2></div>
          <div class="history-block" id="history-feed">No history yet.</div>
        </div>
      </div>
    </details>
  </div>

  <!-- COACHING -->
  <div id="coaching" class="tab-content">
    <div class="dashboard-container" style="grid-template-columns:1fr;">
      <div class="section coaching-form proxy">
        <div class="section-header"><span>ğŸ“</span><h2>Coaching Tracker</h2></div>
        <p class="muted">Coaching lives inside <strong>People &amp; Development</strong>. Use the main dashboard card to add entries.</p>
        <div class="right"><button class="btn btn-primary" data-jump="#coaching-embedded">Go to Coaching</button></div>
        <div class="section" style="margin-top:10px">
          <div class="section-header" style="border-bottom:none"><span>ğŸ“¦</span><h2 style="border:0">Saved Items</h2></div>
          <div class="coaching-list-proxy" style="margin-top:6px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- REPORTS -->
  <div id="reports" class="tab-content">
    <div class="dashboard-container" style="grid-template-columns:1fr 1fr;">
      <div class="section">
        <div class="section-header"><span>ğŸ“ˆ</span><h2>Cases/Hr by Associate</h2></div>
        <canvas id="chart-cph" width="600" height="320" style="width:100%"></canvas>
        <div class="muted">Updates from Freight data.</div>
      </div>
      <div class="section">
        <div class="section-header"><span>ğŸ“Š</span><h2>Zone Completion by Area</h2></div>
        <canvas id="chart-zones" width="600" height="320" style="width:100%"></canvas>
        <div class="muted">Shows % complete in Zone Verification.</div>
      </div>
      <div class="section full-width">
        <div class="section-header"><span>ğŸ§¾</span><h2>Quick Exports</h2></div>
        <div class="right" style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary quick-export" data-export="freight">Export Freight CSV</button>
          <button class="btn btn-primary quick-export" data-export="overstock">Export Overstock CSV</button>
          <button class="btn btn-primary" id="exportZonesBtn">Export Zones CSV</button>
          <button class="btn btn-primary" id="exportToursBtn">Export Tours CSV</button>
          <button class="btn btn-primary" id="exportTopstockQuick">Export Top-Stock CSV</button>
        </div>
      </div>
    </div>
  </div>
    </div>
    </main>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>Department Target Cases/Hr</h3>
      <button class="btn btn-danger" id="closeSettingsBtn">Close</button>
    </div>
    <div id="modal-targets" class="modal-grid"></div>
    <div class="right" style="margin-top:10px">
      <button class="btn btn-success" id="saveDeptTargetsBtn">Save Targets</button>
    </div>
    <div class="muted" style="margin-top:8px">Leave blank to use the global target.</div>
  </div>
</div>

<!-- Exports Modal -->
<div id="exportsModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal">
    <div class="modal-header"><h3>Unified Exports</h3><button class="btn btn-danger" id="closeExports">Close</button></div>
    <div class="modal-grid">
      <button class="btn btn-primary quick-export" data-export="freight">Export Freight</button>
      <button class="btn btn-primary quick-export" data-export="overstock">Export Overstock</button>
      <button class="btn btn-primary" id="exportZonesModal">Export Zones</button>
      <button class="btn btn-primary" id="exportToursModal">Export Fresh Tours</button>
      <button class="btn btn-primary" id="exportTopstockModal">Export Top-Stock</button>
      <button class="btn btn-primary" id="exportCoachingModal">Export Coaching</button>
      <button class="btn btn-success" id="exportShiftReport">Export Shift Report</button>
    </div>
    <p class="muted" style="margin-top:10px">Exports also capture a history snapshot for trends and recurring issues.</p>
  </div>
</div>

<!-- Help / Shortcuts Modal -->
<div id="helpModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal">
    <div class="modal-header"><h3>Keyboard Shortcuts</h3><button class="btn btn-danger" id="closeHelp">Close</button></div>
    <ul class="shortcut-list">
      <li><strong>F</strong> â€” Add Freight Row</li>
      <li><strong>Z</strong> â€” Jump to Zones</li>
      <li><strong>T</strong> â€” Jump to Top-Stock</li>
      <li><strong>C</strong> â€” Open Coaching</li>
      <li><strong>/</strong> â€” Focus search (roster)</li>
    </ul>
  </div>
</div>

<!-- Generic Feature Modal -->
<div id="featureModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="featureTitle">
    <div class="modal-header"><h3 id="featureTitle">Feature</h3><button class="btn btn-danger" id="closeFeature">Close</button></div>
    <div id="featureBody" class="feature-modal-body">Details coming soon.</div>
  </div>
</div>

<!-- History Modal -->
<div id="historyModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal large">
    <div class="modal-header"><h3>History</h3><button class="btn btn-danger" id="closeHistory">Close</button></div>
    <div class="filters" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
      <input class="input-field" type="date" id="historyStart"/>
      <input class="input-field" type="date" id="historyEnd"/>
      <select class="input-field" id="historyStatus">
        <option value="">Any status</option>
        <option>Complete</option>
        <option>On Track</option>
        <option>Needs Work</option>
        <option>Pending</option>
      </select>
    </div>
    <div id="historyBody" class="history-body">No history yet.</div>
  </div>
</div>

<!-- Health score explainer -->
<div id="healthInfoModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal">
    <div class="modal-header"><h3>Shift Health Score</h3><button class="btn btn-danger" id="closeHealthInfo">Close</button></div>
    <p>Health = Freight (35%) + Zone Completion (25%) + Fresh Compliance (25%) + Top-Stock Verification (15%). Scores update automatically.</p>
  </div>
</div>

<!-- Floating quick actions -->
<div class="fab" id="fab" title="Quick add">ï¼‹</div>
<div id="fabSheet" class="action-sheet hidden">
  <button class="btn btn-primary" data-quick="freight">Add Freight Row</button>
  <button class="btn btn-primary" data-quick="coaching">Add Coaching Entry</button>
  <button class="btn btn-primary" data-quick="overstock">Add Overstock Item</button>
</div>

<script>
/* ===== Utilities ===== */
const $=(q,ctx=document)=>ctx.querySelector(q);const $$=(q,ctx=document)=>Array.from(ctx.querySelectorAll(q));
function toMinutes(t){if(!t)return 0;const [h,m]=t.split(':').map(Number);return h*60+m}
function hoursBetween(start,end){if(!start||!end)return 0;let s=toMinutes(start),e=toMinutes(end);if(e<s)e+=1440;return (e-s)/60}
function fmt(n,d=1){return (isFinite(n)?Number(n).toFixed(d):'0')}
function saveLocal(k,d){localStorage.setItem(k,JSON.stringify(d))}
function loadLocal(k,f){try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}}
function download(filename,text){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([text],{type:'text/csv'}));a.download=filename;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove()},0)}
function toast(msg){const t=document.createElement('div');t.textContent=msg;t.style.cssText='position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:10px 14px;border-radius:8px;z-index:9999;font:600 14px system-ui,Segoe UI,sans-serif;';document.body.appendChild(t);setTimeout(()=>{t.style.opacity=0;t.style.transition="opacity .3s"},1200);setTimeout(()=>t.remove(),1600)}
function logAction(action,msg){console.log(`[Dashboard] ${action}`); if(msg) toast(msg);}
const DEFAULT_TARGET_CPH = 45;
const rosterKey='wm_roster';
const rolesKey='wm_roles';
const historyKey='wm_history';

/* ===== Roster & Roles ===== */
function renderRoster(){
  const roster=loadLocal(rosterKey,['Alex','Jordan','Taylor']);
  const input=$('#rosterInput');
  if(input){
    input.onkeydown=(e)=>{ if(e.key==='Enter'){ e.preventDefault(); if(input.value.trim()){ roster.push(input.value.trim()); saveLocal(rosterKey,roster); input.value=''; renderRoster(); toast('Added to roster'); } } };
    input.placeholder = roster.length? 'Add name and press Enter' : 'Add first name';
  }
  updateAssignOptions();
  $$('.assign-select').forEach(sel=>{
    const current=sel.value;
    sel.innerHTML = `<option value="">Unassigned</option><option value="me">Assign to me</option>` + roster.map(n=>`<option value="${n}">${n}</option>`).join('');
    if(current) sel.value=current;
  });
  const roleState=loadLocal(rolesKey,{});
  $$('.role-select').forEach(sel=>{ const curr=roleState[sel.dataset.role]||''; sel.innerHTML=`<option value="">Unassigned</option>`+roster.map(n=>`<option>${n}</option>`).join(''); sel.value=curr; sel.onchange=()=>{ roleState[sel.dataset.role]=sel.value; saveLocal(rolesKey, roleState); updateInsights(); renderTimeline(); }; });
}
function updateAssignOptions(){
  const roster=loadLocal(rosterKey,['Alex','Jordan','Taylor']);
  $$('.assign-select').forEach(sel=>{
    const current=sel.value;
    sel.innerHTML = `<option value="">Unassigned</option><option value="me">Assign to me</option>` + roster.map(n=>`<option value="${n}">${n}</option>`).join('');
    if(current) sel.value=current;
  });
}

/* ===== Header / Theme / Pin ===== */
const departments=['Dry Grocery','Consumables','Dairy','Frozen','Produce','Meat','Deli/Bakery'];
function applyTheme(mode){
  const theme = mode==='dark' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', theme);
  const btn=$('#themeBtn'); if(btn) btn.textContent = theme==='dark' ? 'ğŸŒ™ Dark Mode' : 'â˜€ï¸ Light Mode';
}

function initHeader(){
  const prefs = loadLocal('wm_prefs', {});
  const dateEl = $('#current-date');
  function updateDate(){
    const now=new Date();
    if(dateEl) dateEl.textContent=now.toLocaleString([], {weekday:'short', month:'short', day:'numeric', year:'numeric'});
  }
  updateDate();
  setInterval(updateDate, 60000);
  $('#kpi-target-cph').textContent = DEFAULT_TARGET_CPH;
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
  const storedTheme = prefs.theme;
  applyTheme(storedTheme ?? (prefersDark.matches ? 'dark' : 'light'));
  if(!storedTheme){ prefersDark.addEventListener?.('change', e=>{ const saved=loadLocal('wm_prefs',{}).theme; if(!saved) applyTheme(e.matches?'dark':'light'); }); }
  
  const themeBtn = $('#themeBtn');
  if(themeBtn) themeBtn.addEventListener('click', handleTheme);
  else console.warn('initHeader: #themeBtn not found');
}

/* ===== Tabs ===== */
function initTabs(){
  const navToggle=$('#navToggle');
  const closeNav=()=>{ document.body.classList.remove('nav-open'); navToggle?.setAttribute('aria-expanded','false'); };
  navToggle?.addEventListener('click', ()=>{ const open=document.body.classList.toggle('nav-open'); navToggle.setAttribute('aria-expanded', open ? 'true' : 'false'); logAction(open?'Open nav menu':'Close nav menu', open?'Navigation opened':'Navigation closed'); });
  const activateTab=(t)=>{
    $$('.tab').forEach(x=>{x.classList.remove('active'); x.setAttribute('aria-selected','false');});
    t.classList.add('active'); t.setAttribute('aria-selected','true');
    const tab=t.getAttribute('data-tab');$$('.tab-content').forEach(c=>c.classList.remove('active'));$('#'+tab).classList.add('active');
    closeNav();
    if(tab==='reports') drawCharts();
    logAction(`Switch to ${tab} tab`,`Switched to ${t.textContent.trim()}`);
  };
  $$('.tab').forEach(t=>{
    t.addEventListener('click',()=>activateTab(t));
    t.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); activateTab(t); } });
  });
}

/* ===== Dept targets ===== */
function renderDeptTargets(){
  const state = loadLocal('wm_dept_targets', {});
  const wrap = $('#dept-targets'); wrap.innerHTML='';
  departments.forEach(d=>{
    const v = state[d] ?? '';
    wrap.insertAdjacentHTML('beforeend', `<label class="target-row"><span class="target-pill">${d}</span><input class="input-field dt target-input" data-dept="${d}" type="number" min="1" placeholder="â€”" value="${v!==''?v:''}"/></label>`);
  });
}
function toggleModal(show=true){
  const m=$('#settingsModal'); if(!m) return;
  m.classList.toggle('hidden', !show);
  m.setAttribute('aria-hidden', show ? 'false' : 'true');
  if(show){
    const box=$('#modal-targets'); box.innerHTML='';
    const current=loadLocal('wm_dept_targets', {});
    departments.forEach(d=>{
      const v=current[d]??'';
      box.insertAdjacentHTML('beforeend',`<div class="target-row"><span class="target-pill">${d}</span><input class="input-field modal-dt target-input" data-dept="${d}" type="number" min="1" placeholder="â€”" value="${v!==''?v:''}"/></div>`);
    });
    logAction('Open settings modal','Department targets opened');
  } else {
    logAction('Close settings modal','Department targets closed');
  }
}
function saveDeptTargets(){
  const obj={}; $$('.modal-dt').forEach(i=>{ const val=i.value.trim(); if(val!=='') obj[i.dataset.dept]=Number(val)});
  saveLocal('wm_dept_targets', obj); renderDeptTargets(); recalcFreight(); toggleModal(false); logAction('Save department targets','Department targets saved');
}

/* ===== Freight ===== */
function freightRowTemplate(){
  return `<tr class="swipeable">
    <td><input type="checkbox" class="row-select freight-select"/></td>
    <td><input class="input-field assoc" placeholder="Associate Name"/></td>
    <td><select class="input-field dept">${departments.map(d=>`<option>${d}</option>`).join('')}</select></td>
    <td><input type="time" class="input-field cin"/></td>
    <td><input type="time" class="input-field cout"/></td>
    <td><input type="number" min="0" class="input-field cases" placeholder="0"/></td>
    <td class="hours-cell">0.0</td>
    <td class="caseshr-cell">0.0</td>
    <td><select class="input-field assign-select freight-assign"></select></td>
    <td class="status-cell"><span class="status-badge">Pending</span></td>
    <td class="right"><button class="btn btn-danger btn-sm delete-row" type="button">âœ–</button></td>
  </tr>`;
}
function addFreightRow(showFeedback=true){
  $('#freight-tbody').insertAdjacentHTML('beforeend', freightRowTemplate());
  const row=$('#freight-tbody').lastElementChild;
  hookFreightInputs(row);
  updateAssignOptions();
  if(showFeedback) logAction('Add freight row','Added freight row');
}
function hookFreightInputs(scope){
  const ctx=scope||document;
  ctx.querySelectorAll('#freight-tbody input,#freight-tbody select').forEach(el=>{
    el.addEventListener('input', recalcFreight);
    el.addEventListener('change', recalcFreight);
  });
}
function deleteRow(el){
  const tr=el.closest('tr'); if(!tr) return;
  const isFreight=Boolean(tr.closest('#freight-tbody'));
  tr.remove();
  if(isFreight) recalcFreight();
}
function badgeForCPH(cph, dept){
  const deptTargets = loadLocal('wm_dept_targets', {});
  const globalTarget = DEFAULT_TARGET_CPH;
  const target = Number(deptTargets[dept]) || globalTarget;
  if(isNaN(cph)||!isFinite(cph)||cph<=0) return ['status-badge','Pending'];
  if(cph >= target*1.15) return ['status-badge status-excellent', `${fmt(cph)} â­`];
  if(cph >= target) return ['status-badge status-good', `${fmt(cph)} âœ…`];
  if(cph >= target*0.75) return ['status-badge status-warning', `${fmt(cph)} âš ï¸`];
  return ['status-badge status-danger', `${fmt(cph)} âŒ`];
}
function recalcFreight(){
  const rows=[...$('#freight-tbody').rows]; let totalCases=0,totalHours=0, good=0;
  const deptTargets = loadLocal('wm_dept_targets', {});
  rows.forEach(r=>{
    const dept=$('.dept',r).value;
    const cases=Number($('.cases',r).value)||0;
    const h=hoursBetween($('.cin',r).value,$('.cout',r).value);
    const cph=h>0?cases/h:0;
    totalCases+=cases; totalHours+=h;
    $('.hours-cell',r).textContent=fmt(h);
    $('.caseshr-cell',r).textContent=fmt(cph);
    const [cls,label]=badgeForCPH(cph, dept);
    $('.status-cell',r).innerHTML=`<span class="${cls}">${label}</span>`;
    const target = Number(deptTargets[dept]) || DEFAULT_TARGET_CPH;
    if(cph >= target) good++;
  });
  const teamCPH = totalHours>0? totalCases/totalHours : 0;
  $('#kpi-total-cases').textContent=totalCases; $('#kpi-total-hours').textContent=fmt(totalHours); $('#kpi-avg-cph').textContent=fmt(teamCPH);
  $('#team-summary').textContent=`Team CPH ${fmt(teamCPH)} â€¢ ${good}/${rows.length} meeting dept/global targets â€¢ Total ${totalCases} cases in ${fmt(totalHours)} hrs.`;
  updateInsights();
  updateHealth();
  drawCharts();
}

/* ===== CSV Imports ===== */
function parseCSV(text){
  const lines=text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length);
  const headers=lines.shift().split(',').map(h=>h.trim().toLowerCase());
  const rows=lines.map(l=>{
    const parts=[]; let cur='',inQ=false;
    for(let i=0;i<l.length;i++){
      const ch=l[i];
      if(ch=='"'){ if(l[i+1]=='"'){cur+='"'; i++;} else { inQ=!inQ; } }
      else if(ch===',' && !inQ){ parts.push(cur); cur=''; }
      else{ cur+=ch; }
    }
    parts.push(cur);
    const obj={};
    headers.forEach((h,idx)=>obj[h]=parts[idx]?.trim()||'');
    return obj;
  });
  return {headers, rows};
}
$('#importRoster').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader(); reader.onload=()=>{
    const {rows}=parseCSV(reader.result);
    rows.forEach(r=>{
      addFreightRow(false);
      const tr=$('#freight-tbody').lastElementChild;
      $('.assoc',tr).value = r['associate'] || r['name'] || '';
      $('.dept',tr).value = r['department'] || departments[0];
      $('.cin',tr).value = r['clock in'] || r['clockin'] || r['in'] || '';
      $('.cout',tr).value = r['clock out'] || r['clockout'] || r['out'] || '';
      $('.cases',tr).value = r['cases'] || r['case'] || 0;
    });
    recalcFreight();
    logAction('Import roster CSV','Roster imported');
    e.target.value='';
  };
  reader.readAsText(f);
});
$('#importOverstock').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader(); reader.onload=()=>{
    const {rows}=parseCSV(reader.result);
    rows.forEach(r=>{
      addOverstockRow(false);
      const tr=$('#overstock-tbody').lastElementChild;
      $('.loc',tr).value = r['location']||'';
      $('.upc',tr).value = r['item/upc']||r['upc']||r['item']||'';
      $('.qty',tr).value = r['qty']||r['quantity']||0;
      $('.action',tr).value = r['action']||'Binned';
      const st = (r['status']||'Pending');
      const sel=tr.querySelector('.status-select');
      if(sel){ sel.value=st; colorOverstockStatus(sel); }
    });
    logAction('Import overstock CSV','Overstock imported');
    e.target.value='';
  };
  reader.readAsText(f);
});

/* ===== Zones ===== */
const zoneDefaults=[{name:'Dry Grocery',total:14,type:'count'},{name:'Consumables',total:10,type:'count'},
{name:'Produce',total:1,type:'check'},{name:'Meat',total:1,type:'check'},{name:'Deli/Bakery',total:1,type:'check'},
{name:'Dairy',total:3,type:'count'},{name:'Frozen',total:4,type:'count'}];
function initZones(){
  const tb=$('#zone-tbody'); tb.innerHTML='';
  zoneDefaults.forEach(z=>{
    const completedInput = z.type==='check' ? `<input type="checkbox" class="checkbox zdone" data-total="${z.total}"/>`
      : `<input type="number" class="input-field zcount" min="0" max="${z.total}" value="0" data-total="${z.total}"/>`;
    tb.insertAdjacentHTML('beforeend', `<tr>
      <td><input type="checkbox" class="row-select zone-select"/></td>
      <td><span class="target-pill">${z.name}</span></td>
      <td>${z.total}</td><td>${completedInput}</td><td class="zone-percent">0%</td>
      <td><select class="input-field assign-select zone-assign"></select></td>
      <td class="zone-status"><span class="status-badge status-danger">âŒ Incomplete</span></td>
      <td><button class="btn btn-sm history-btn" data-type="zone" data-zone="${z.name}">History</button></td></tr>`);
  });
  tb.querySelectorAll('.zcount').forEach(i=>i.addEventListener('change',()=>updateZoneRow(i)));
  tb.querySelectorAll('.zdone').forEach(i=>i.addEventListener('change',()=>updateZoneRow(i)));
  updateZoneTotals();
  updateAssignOptions();
}
function zoneStatus(pct){ if(pct>=100) return ['âœ… Complete','status-badge status-excellent']; if(pct>=75) return ['ğŸŸ¡ On Track','status-badge status-good']; if(pct>0) return ['âš ï¸ In Progress','status-badge status-warning']; return ['âŒ Incomplete','status-badge status-danger'] }
function updateZoneRow(input){
  const tr=input.closest('tr'); const total=Number(input.dataset.total)||1;
  const done = input.classList.contains('zcount') ? Math.max(0,Math.min(total, Number(input.value)||0)) : (input.checked?1:0);
  const pct=Math.round((done/total)*100);
  $('.zone-percent',tr).textContent=pct+'%'; const [text,cls]=zoneStatus(pct); $('.zone-status',tr).innerHTML=`<span class="${cls}">${text}</span>`; updateZoneTotals();
}
function updateZoneTotals(){
  const rows=[...$('#zone-tbody').rows]; let totalA=0,totalD=0;
  rows.forEach(r=>{const total=Number(r.cells[2].textContent)||1; totalA+=total; const pct=Number(r.cells[4].textContent.replace('%',''))||0; totalD+=Math.round(pct*total/100)});
  const overall=Math.round((totalD/totalA)*100)||0; $('#zone-progress').style.width=overall+'%'; $('#zone-progress').textContent=overall+'% Complete';
  updateInsights();
  updateHealth();
  drawCharts();
}

/* ===== Tours ===== */
const tourSlots=[['Opening Walk','06:30'],['Mid-Morning','10:00'],['Lunch Check','13:00'],['Afternoon','16:00'],['Evening','19:00']];
function initTours(){
  const tb=$('#tours-tbody'); tb.innerHTML='';
  tourSlots.forEach(([label,target])=>{
    tb.insertAdjacentHTML('beforeend', `<tr>
      <td><input type="checkbox" class="row-select tour-select"/></td>
      <td><strong>${label}</strong></td><td>${target}</td>
      <td><input type="time" class="input-field t-actual"/></td>
      <td><select class="input-field assign-select tour-assign"></select></td>
      <td class="countdown">--</td>
      <td><input type="checkbox" class="checkbox tck"/></td>
      <td><input type="checkbox" class="checkbox tck"/></td>
      <td><input type="checkbox" class="checkbox tck"/></td>
      <td><input type="checkbox" class="checkbox tck"/></td>
      <td><input type="checkbox" class="checkbox tck"/></td>
      <td><input type="checkbox" class="checkbox tck"/></td>
      <td><input type="text" class="input-field t-temp" placeholder="Â°F"/></td>
      <td class="tour-status"><span class="time-indicator" style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#ffb81c;margin-right:6px"></span>Pending</td>
      <td><button class="btn btn-sm history-btn" data-type="fresh" data-slot="${label}">History</button></td>
    </tr>`);
  });
  $('#tours-tbody').querySelectorAll('.t-actual').forEach(i=>i.addEventListener('change',()=>updateTourRow(i)));
  $('#tours-tbody').querySelectorAll('.tck').forEach(i=>i.addEventListener('change',()=>updateTourRow(i)));
  updateAssignOptions();
}
function updateTourRow(input){
  const tr=input.closest('tr'); const target=tr.cells[2].textContent.trim(); const actual=$('.t-actual',tr).value;
  const checks=$$('.tck',tr); const allDone=checks.length && checks.every(c=>c.checked);
  let statusText='Pending', color='#ffb81c';
  if(actual){ const diff=Math.abs(toMinutes(actual)-toMinutes(target)); if(diff<=20){statusText='On Time'; color='#00a651'} else if(diff<=45){statusText='Late'; color='#ffb81c'} else {statusText='Overdue'; color='#e31837'} }
  if(allDone && actual){ statusText+=' â€¢ All checks done' }
  tr.querySelector('.tour-status').innerHTML = `<span class="time-indicator" style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${color};margin-right:6px"></span>${statusText}`;
  updateCountdowns();
  updateInsights();
  updateHealth();
}
function exportToursCSV(showFeedback=true){
  const rows=[...$('#tours-tbody').rows];
  const headers=['Slot','Target','Actual','Assigned','Countdown','Produce','Meat','Deli','Bakery','Dairy','Frozen','Temp','Status'];
  const csv=[headers.join(',')].concat(rows.map(r=>{
    const vals=[r.cells[1].innerText.trim(),r.cells[2].innerText.trim(),$('.t-actual',r).value||'', $('.tour-assign',r).value||'', r.cells[5].innerText.trim(), ...$$('.tck',r).map(c=>c.checked?'âœ”':''),r.cells[12].querySelector('input')?.value||'',r.cells[13].innerText.trim()];
    return vals.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
  })).join('\n'); download('tours.csv',csv); if(showFeedback) logAction('Export tours CSV','Tours CSV exported');
}

/* ===== Overstock ===== */
function overstockRowTemplate(){
  return `<tr class="swipeable">
    <td><input type="checkbox" class="row-select overstock-select"/></td>
    <td><input class="input-field loc" placeholder="Aisle/Section"/></td>
    <td><input class="input-field upc" placeholder="UPC or Description"/></td>
    <td><input class="input-field qty" type="number" min="0" placeholder="0"/></td>
    <td><select class="input-field action"><option>Binned</option><option>Flexed</option><option>Worked</option><option>RTV</option><option>Claims</option></select></td>
    <td><select class="input-field assign-select overstock-assign"></select></td>
    <td class="status-cell">
      <select class="input-field status-select">
        <option>Pending</option><option>In Progress</option><option>Done</option>
      </select>
      <span class="status-badge status-danger status-display">Pending</span>
    </td>
    <td class="right"><button class="btn btn-danger delete-row" type="button">âœ–</button></td>
  </tr>`;
}
function addOverstockRow(showFeedback=true){
  $('#overstock-tbody').insertAdjacentHTML('beforeend', overstockRowTemplate());
  const row=$('#overstock-tbody').lastElementChild;
  hookOverstockInputs(row);
  updateAssignOptions();
  if(showFeedback) logAction('Add overstock item','Added overstock item');
}
function colorOverstockStatus(sel){
  const td=sel.closest('.status-cell');
  const display=td?.querySelector('.status-display');
  let cls='status-badge status-danger', txt=sel.value;
  if(sel.value==='Done') cls='status-badge status-excellent'; else if(sel.value==='In Progress') cls='status-badge status-good';
  if(display){ display.className=`${cls} status-display`; display.textContent=txt; }
}
function hookOverstockInputs(scope){
  const ctx=scope||document;
  ctx.querySelectorAll('#overstock-tbody input,#overstock-tbody select').forEach(el=>{
    if(el.classList.contains('status-select')){
      el.addEventListener('change', e=>{ colorOverstockStatus(e.target); logAction('Update overstock status','Updated overstock status'); updateInsights(); });
    } else {
      el.addEventListener('change', ()=>{ logAction('Edit overstock row'); updateInsights(); });
    }
  });
}
function exportTableCSV(which, showFeedback=true){
  let rows=[], headers=[];
  if(which==='freight'){
    headers=['Associate','Department','Clock In','Clock Out','Cases','Hours','Cases/Hr','Assigned','Status'];
    rows=[...$('#freight-tbody').rows].map(r=>[$('.assoc',r).value,$('.dept',r).value,$('.cin',r).value,$('.cout',r).value,$('.cases',r).value,$('.hours-cell',r).innerText.trim(),$('.caseshr-cell',r).innerText.trim(),$('.freight-assign',r)?.value||'',r.querySelector('.status-cell')?.innerText.trim()]);
  }else if(which==='overstock'){
    headers=['Location','Item/UPC','Qty','Action','Assigned','Status'];
    rows=[...$('#overstock-tbody').rows].map(r=>[$('.loc',r).value,$('.upc',r).value,$('.qty',r).value,$('.action',r).value,$('.overstock-assign',r)?.value||'',(r.querySelector('.status-display')?.innerText || r.querySelector('.status-select')?.value || '')]);
  }
  const csv=[headers.join(',')].concat(rows.map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','))).join('\n'); download(`${which}.csv`,csv); if(showFeedback) logAction(`Export ${which} CSV`,`${which.charAt(0).toUpperCase()+which.slice(1)} CSV exported`);
}
function exportZonesCSV(showFeedback=true){
  const headers=['Zone','Total','Completed','Percent','Status'];
  const csv=[headers.join(',')].concat([...$('#zone-tbody').rows].map(r=>{
    const zone=r.cells[1].innerText.trim(), total=r.cells[2].innerText.trim();
    const compCell=r.cells[3]; const comp=(compCell.querySelector('.zcount')?.value) ?? (compCell.querySelector('.zdone')?.checked ? '1' : '0');
    const pct=r.cells[4].innerText.trim(); const st=r.cells[6].innerText.trim();
    return [zone,total,comp,pct,st].map(v=>`"${v}"`).join(',');
  })).join('\n'); download('zones.csv',csv); if(showFeedback) logAction('Export zones CSV','Zones CSV exported');
}

/* ===== Coaching save/export ===== */
function getCoachingForm(){
  const issues=$$('.coach-issue:checked').map(c=>c.value);
  return {associate:$('#coach-assoc').value.trim(),dept:$('#coach-dept').value,follow:$('#coach-follow').value,goals:$('#coach-goals').value.trim(),notes:$('#coach-notes').value.trim(),issues};
}
function saveCoaching(){ const entry=getCoachingForm(); const list=loadLocal('coach_entries',[]); list.push({...entry, ts:new Date().toISOString()}); saveLocal('coach_entries',list); renderCoachingList(); logAction('Save coaching entry','Coaching saved'); }
function renderCoachingList(){
  const box=$('#coaching-list'); const proxies=$$('.coaching-list-proxy');
  box.innerHTML=''; const list=loadLocal('coach_entries',[]);
  proxies.forEach(p=>p.innerHTML='');
  if(!list.length){ box.textContent='No entries yet.'; proxies.forEach(p=>p.textContent='No entries yet.'); return; }
  list.forEach((e,i)=>{
    const div=document.createElement('div'); div.style.padding='8px 0';
    const date=new Date(e.ts).toLocaleString();
    div.innerHTML=`#${i+1} â€¢ ${date} â€¢ <strong>${e.associate}</strong> (${e.dept}) â€¢ Issues: ${e.issues.join(', ')||'â€”'} `;
    box.appendChild(div.cloneNode(true));
    proxies.forEach(p=>p.appendChild(div.cloneNode(true)));
  });
}
function exportCoaching(){
  const list=loadLocal('coach_entries',[]);
  const headers=['Timestamp','Associate','Dept','Issues','Follow-Up','Goals','Notes'];
  const csv=[headers.join(',')].concat(list.map(e=>[e.ts,e.associate,e.dept,(e.issues||[]).join('; '),e.follow,e.goals,e.notes].map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','))).join('\n');
  download('coaching.csv',csv); logAction('Export coaching CSV','Coaching CSV exported');
}
function clearCoaching(){ localStorage.removeItem('coach_entries'); renderCoachingList(); logAction('Clear coaching entries','Coaching cleared'); }

/* ===== Top-Stock Checklist ===== */
const topA = Array.from({length:20}, (_,i)=>`A${i+1}`);
const topB = Array.from({length:10}, (_,i)=>`B${i+1}`);
function initTopstock(){
  const grid=$('#topstock-grid'); grid.innerHTML='';
  const makeCard=(id)=>`
    <div class="topstock-card">
      <div class="topstock-head">
        <strong>${id}</strong>
        <select class="input-field ts-status target-input" data-id="${id}">
          <option value="Verified">Verified</option>
          <option value="Needs Work">Needs Work</option>
          <option value="Blocked">Blocked</option>
        </select>
      </div>
      <select class="input-field assign-select ts-owner" data-id="${id}"></select>
      <div class="target-row topstock-row"><label><input type="checkbox" class="checkbox ts-check" data-id="${id}"/> Verified</label></div>
      <input class="input-field ts-notes" data-id="${id}" placeholder="Notes (bins, modular, safety, etc.)"/>
    </div>`;
  [...topA,...topB].forEach(id=>grid.insertAdjacentHTML('beforeend', makeCard(id)));
  $$('.ts-check').forEach(c=>c.addEventListener('change',()=>{updateTopstockProgress(); logAction('Toggle top-stock checkbox','Top-stock updated');}));
  $$('.ts-status').forEach(s=>s.addEventListener('change',()=>{updateTopstockProgress(); logAction('Update top-stock status','Top-stock updated');}));
  updateAssignOptions();
  updateTopstockProgress();
}
function updateTopstockProgress(){
  const checks=$$('.ts-check'); const total=checks.length; const verified=checks.filter(c=>c.checked).length;
  const pct=Math.round((verified/total)*100)||0; $('#topstock-progress').style.width=pct+'%'; $('#topstock-progress').textContent=pct+'% Verified';
  updateInsights(); updateHealth();
}
function markTopstockAll(val, showFeedback=true){ $$('.ts-check').forEach(c=>c.checked=val); updateTopstockProgress(); if(showFeedback) logAction(val?'Mark all top-stock verified':'Clear all top-stock','Top-stock checkboxes updated'); }
function exportTopstockCSV(showFeedback=true){
  const ids=[...topA,...topB]; const headers=['Aisle','Verified','Status','Notes'];
  const rows=ids.map(id=>{ const v=Boolean(document.querySelector(`.ts-check[data-id="${id}"]`)?.checked); const st=document.querySelector(`.ts-status[data-id="${id}"]`)?.value||''; const note=document.querySelector(`.ts-notes[data-id="${id}"]`)?.value||''; return [id,v?'Yes':'No',st,note]; });
  const csv=[headers.join(',')].concat(rows.map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','))).join('\n'); download('topstock.csv',csv); if(showFeedback) logAction('Export top-stock CSV','Top-stock CSV exported');
}

/* ===== Charts (placeholder simple) ===== */
function drawCharts(){
  const cphCanvas=$('#chart-cph'); const zonesCanvas=$('#chart-zones');
  if(cphCanvas){
    const ctx=cphCanvas.getContext('2d'); ctx.clearRect(0,0,cphCanvas.width,cphCanvas.height);
    const rows=[...$('#freight-tbody').rows]; const data=rows.map(r=>({name:$('.assoc',r).value||'Assoc', cph:Number($('.caseshr-cell',r).textContent)||0}));
    const max=Math.max(10,...data.map(d=>d.cph)); const barW=(cphCanvas.width-40)/(data.length||1);
    data.forEach((d,i)=>{ const h=(d.cph/max)*(cphCanvas.height-60); ctx.fillStyle='#2563eb'; ctx.fillRect(20+i*barW, cphCanvas.height-20-h, barW-10, h); ctx.fillStyle='#111'; ctx.fillText(d.name, 20+i*barW, cphCanvas.height-6); ctx.fillText(d.cph.toFixed(1), 20+i*barW, cphCanvas.height-30-h); });
  }
  if(zonesCanvas){
    const ctx=zonesCanvas.getContext('2d'); ctx.clearRect(0,0,zonesCanvas.width,zonesCanvas.height);
    const zones=[...$('#zone-tbody').rows].map(r=>Number($('.zone-percent',r).textContent.replace('%',''))||0);
    const step=(zonesCanvas.width-40)/Math.max(1,zones.length-1);
    ctx.strokeStyle='#16a34a'; ctx.beginPath(); ctx.moveTo(20, zonesCanvas.height-20-(zones[0]||0)*2);
    zones.forEach((v,i)=>{ const x=20+i*step; const y=zonesCanvas.height-20-(v*2); ctx.lineTo(x,y); ctx.fillRect(x-2,y-2,4,4); });
    ctx.stroke();
  }
}

/* ===== Insights, Status, Health ===== */
function moduleStatus(){
  const freightRows=[...$('#freight-tbody').rows];
  const slow=freightRows.filter(r=>$('.status-cell',r).innerText.includes('âŒ')).length;
  const warn=freightRows.filter(r=>$('.status-cell',r).innerText.includes('âš ï¸')).length;
  const zonesPct=parseInt($('#zone-progress').textContent)||0;
  const zoneRed=zonesPct<50;
  const tours=[...$('#tours-tbody').rows];
  const overdueTours=tours.filter(r=>r.querySelector('.tour-status')?.innerText.includes('Overdue')).length;
  const topPct=parseInt($('#topstock-progress').textContent)||0;
  return {
    freight: slow>0? 'red' : warn>0? 'yellow':'green',
    zones: zoneRed? 'red': zonesPct>=90?'green':'yellow',
    fresh: overdueTours>0? 'red': 'green',
    topstock: topPct>=90?'green': topPct>50?'yellow':'red',
    overstock: [...$('#overstock-tbody').rows].some(r=>r.querySelector('.status-display')?.innerText.includes('Pending'))?'yellow':'green',
    coaching: loadLocal('coach_entries',[]).length? 'green':'yellow'
  };
}
function applyStatus(el,status){ if(!el) return; el.className='module-status '+status; el.textContent=status==='red'?'ğŸš¨ Critical':status==='yellow'?'âš ï¸ Watching':'âœ… Healthy'; }
function updateGroupStatus(){
  const ms=moduleStatus();
  applyStatus($('#status-freight'), ms.freight);
  applyStatus($('#status-zones'), ms.zones);
  applyStatus($('#status-fresh'), ms.fresh);
  applyStatus($('#status-topstock'), ms.topstock);
  applyStatus($('#status-overstock'), ms.overstock);
  applyStatus($('#status-coaching'), ms.coaching);
  const groupWorst=(items)=> items.includes('red')?'red': items.includes('yellow')?'yellow':'green';
  applyStatus($('#group-live-status'), groupWorst([ms.freight,ms.zones,ms.fresh]));
  applyStatus($('#group-compliance-status'), groupWorst([ms.topstock,ms.overstock]));
  applyStatus($('#group-people-status'), groupWorst([ms.coaching]));
}
function updateInsights(){
  const roster=loadLocal(rosterKey,[]);
  const freightRows=[...$('#freight-tbody').rows];
  const slow=freightRows.filter(r=>$('.status-cell',r).innerText.includes('âŒ')).map(r=>$('.assoc',r).value||'Unassigned');
  $('#insight-freight').textContent = slow.length? `${slow.length} associates below target: ${slow.join(', ')}` : 'All associates at or above target.';
  const zones=[...$('#zone-tbody').rows];
  const lowest=zones.reduce((acc,r)=>{const pct=Number($('.zone-percent',r).textContent.replace('%',''))||0; return pct<(acc?.pct??101)?{name:r.cells[1].innerText.trim(),pct}:acc;},null);
  $('#insight-zones').textContent = lowest? `${lowest.name} is bottleneck (${lowest.pct}% complete)` : 'No zone data yet.';
  const tours=[...$('#tours-tbody').rows];
  const next=tours.map(r=>({slot:r.cells[1].innerText.trim(), target:r.cells[2].innerText.trim()})).sort((a,b)=>toMinutes(a.target)-toMinutes(b.target))[0];
  const nowM=toMinutes(new Date().toTimeString().slice(0,5));
  const mins=next? toMinutes(next.target)-nowM:0; const label=mins>0? `${Math.round(mins)} mins`:'Now';
  $('#insight-fresh').textContent = next? `Next check (${next.slot}) in ${label}`:'No tours scheduled';
  const needsWork=[...document.querySelectorAll('.ts-status')].filter(s=>s.value==='Needs Work').map(s=>s.closest('.topstock-card')?.querySelector('strong')?.innerText||'');
  $('#insight-topstock').textContent = needsWork.length? `${needsWork.slice(0,3).join(', ')} flagged Needs Work` : 'Top-Stock looks healthy.';
  const overPend=[...$('#overstock-tbody').rows].filter(r=>r.querySelector('.status-display')?.innerText==='Pending');
  $('#insight-overstock').textContent = overPend.length? `${overPend.length} items awaiting action`:'All overstock resolved.';
  const coach=loadLocal('coach_entries',[]);
  $('#insight-coaching').textContent = coach.length? `${coach.length} follow-ups tracked`:'No coaching entries yet.';
  updateGroupStatus();
}
function updateHealth(){
  const freightScore=Math.min(1, (Number($('#kpi-avg-cph').textContent)||0)/(DEFAULT_TARGET_CPH));
  const zoneScore=(parseInt($('#zone-progress').textContent)||0)/100;
  const freshRows=[...$('#tours-tbody').rows];
  const onTime=freshRows.filter(r=>r.querySelector('.tour-status')?.innerText.includes('On Time')).length;
  const freshScore=freshRows.length? onTime/freshRows.length : 0;
  const topScore=(parseInt($('#topstock-progress').textContent)||0)/100;
  const score=Math.round((freightScore*0.35 + zoneScore*0.25 + freshScore*0.25 + topScore*0.15)*100);
  $('#health-score').textContent=score;
  $('#health-pill').title='Click to see how score is calculated';
}

/* ===== Countdown & Timeline ===== */
function updateCountdowns(){
  const nowM=toMinutes(new Date().toTimeString().slice(0,5));
  $('#tours-tbody')?.querySelectorAll('tr').forEach(tr=>{
    const target=toMinutes(tr.cells[2].innerText.trim());
    const cell=tr.querySelector('.countdown');
    if(!cell) return;
    let diff=target-nowM; let label='--'; let cls='';
    if(isFinite(diff)){
      if(diff>=0){ label=`${Math.floor(diff/60)}h ${Math.abs(diff%60)}m`; cls=''; }
      else { label=`Overdue by ${Math.abs(Math.floor(diff/60))}h ${Math.abs(diff%60)}m`; cls='danger-text'; }
    }
    cell.textContent=label;
    cell.className='countdown '+cls;
  });
}
function renderTimeline(){
  const bar=$('#shiftTimeline'); if(!bar) return; bar.innerHTML='';
  const day=24*60;
  const nowPct=(toMinutes(new Date().toTimeString().slice(0,5))/day)*100;
  const nowMarker=document.createElement('div'); nowMarker.className='timeline-now'; nowMarker.style.left=nowPct+'%'; nowMarker.textContent='Now'; bar.appendChild(nowMarker);
  tourSlots.forEach(([label,time])=>{ const mk=document.createElement('div'); mk.className='timeline-marker'; mk.style.left=((toMinutes(time)/day)*100)+'%'; mk.textContent=label; bar.appendChild(mk); });
  const followups=loadLocal('coach_entries',[]).filter(c=>c.follow);
  followups.forEach(f=>{ const dt=new Date(f.follow+'T12:00'); const pct=((dt.getHours()*60+dt.getMinutes())/day)*100; const mk=document.createElement('div'); mk.className='timeline-marker followup'; mk.style.left=pct+'%'; mk.textContent='Follow-up'; bar.appendChild(mk); });
}

/* ===== Shortcuts & Navigation ===== */
function initShortcuts(){
  document.addEventListener('keydown',e=>{
    if(['INPUT','TEXTAREA','SELECT'].includes(document.activeElement?.tagName)) return;
    if(e.key==='f' || e.key==='F'){ addFreightRow(); toast('Added freight row'); }
    if(e.key==='z' || e.key==='Z'){ document.querySelector('#zones')?.scrollIntoView({behavior:'smooth'}); toast('Jumped to Zones'); }
    if(e.key==='t' || e.key==='T'){ document.querySelector('#topstock')?.scrollIntoView({behavior:'smooth'}); toast('Jumped to Top-Stock'); }
    if(e.key==='c' || e.key==='C'){ document.querySelector('#coaching-embedded')?.scrollIntoView({behavior:'smooth'}); toast('Opened Coaching'); }
    if(e.key==='/'){ $('#rosterInput')?.focus(); e.preventDefault(); }
  });
}
function initNavHighlight(){
  const links=$$('.quick-link');
  const obs=new IntersectionObserver(entries=>{ entries.forEach(en=>{ if(en.isIntersecting){ links.forEach(l=>{ if(l.getAttribute('href').slice(1)===en.target.id) l.classList.add('active'); else l.classList.remove('active'); }); } }); },{rootMargin:'-30% 0px -60% 0px'});
  ['freight','zones','fresh','topstock','overstock','coaching-embedded'].forEach(id=>{ const el=document.getElementById(id); if(el) obs.observe(el); });
  links.forEach(l=>l.addEventListener('click',e=>{ e.preventDefault(); document.querySelector(l.getAttribute('href'))?.scrollIntoView({behavior:'smooth'}); }));
}

/* ===== Bulk & Swipe ===== */
function setupBulk(containerSel, toolbarSel){
  const container=$(containerSel), toolbar=$(toolbarSel); if(!container||!toolbar) return;
  container.addEventListener('change',()=>{
    const any=[...container.querySelectorAll('.row-select')].some(c=>c.checked);
    toolbar.classList.toggle('hidden', !any);
  });
}
function initSwipeables(){
  let startX=0, target=null;
  document.addEventListener('pointerdown',e=>{ const row=e.target.closest('.swipeable'); if(row){ startX=e.clientX; target=row; } });
  document.addEventListener('pointerup',e=>{
    if(!target) return;
    const dx=e.clientX-startX;
    if(Math.abs(dx)>60){
      const s=target.querySelector('.status-select');
      if(dx>0){
        target.classList.add('swiped');
        if(s) s.value='Done';
      } else {
        target.classList.add('swiped-left');
        if(s) s.value='Pending';
      }
    }
    target=null;
    updateInsights();
  });
}

/* ===== History ===== */
function recordHistory(){
  const list=loadLocal(historyKey,[]);
  const snap=snapshot();
  list.push({ts:Date.now(),snap});
  saveLocal(historyKey,list.slice(-50));
}
function openHistory(filter){
  const list=loadLocal(historyKey,[]).reverse();
  const body=$('#historyBody');
  if(!list.length){ body.textContent='No history yet.'; return; }
  const start=$('#historyStart').value? new Date($('#historyStart').value).getTime():0;
  const end=$('#historyEnd').value? new Date($('#historyEnd').value).getTime():Date.now();
  const status=$('#historyStatus').value;
  body.innerHTML='';
  list.filter(h=>h.ts>=start && h.ts<=end).forEach(h=>{
    const div=document.createElement('div');
    const date=new Date(h.ts).toLocaleString();
    div.className='history-row';
    div.textContent=`${date} â€¢ Freight rows: ${h.snap.freight.length}, Zones: ${h.snap.zones.map(z=>z.zone+':'+z.val).join(' | ')}`;
    body.appendChild(div);
  });
}

/* ===== Exports / Shift Report ===== */
function exportShiftReport(){
  const snap=snapshot();
  recordHistory();
  const report={
    generated:new Date().toISOString(),
    roster:snap.roster,
    roles:snap.roles,
    health:$('#health-score').textContent,
    freight:snap.freight,
    zones:snap.zones,
    tours:snap.tours,
    overstock:snap.overstock,
    topstock:snap.topstock,
    coaching:snap.coaching
  };
  download('shift_report.json', JSON.stringify(report,null,2));
  toast('Shift report downloaded');
}

/* ===== FAB ===== */
function initFab(){
  const fab=$('#fab'), sheet=$('#fabSheet');
  fab?.addEventListener('click',()=>sheet?.classList.toggle('hidden'));
  sheet?.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',()=>{
    sheet.classList.add('hidden');
    if(btn.dataset.quick==='freight') addFreightRow();
    if(btn.dataset.quick==='coaching') $('#coaching-embedded')?.scrollIntoView({behavior:'smooth'});
    if(btn.dataset.quick==='overstock') addOverstockRow();
  }));
}

/* ===== Snapshot / Restore ===== */
function snapshot(){
  const prefs = loadLocal('wm_prefs', {});
  const deptTargets = loadLocal('wm_dept_targets', {});
  const roster = loadLocal('wm_roster', []);
  const roles = loadLocal('wm_roles', {});
  const freight=[...$('#freight-tbody').rows].map(r=>({assoc:$('.assoc',r).value,dept:$('.dept',r).value,cin:$('.cin',r).value,cout:$('.cout',r).value,cases:Number($('.cases',r).value||0),assign:$('.freight-assign',r)?.value||''}));
  // zones
  const zones=[...$('#zone-tbody').rows].map(r=>{
    const zone=r.cells[1].innerText.trim(); const total=Number(r.cells[2].innerText.trim());
    const compCell=r.cells[3]; const val=(compCell.querySelector('.zcount')?.value) ?? (compCell.querySelector('.zdone')?.checked ? 1 : 0);
    return {zone,total,val,assign:r.querySelector('.zone-assign')?.value||''};
  });
  // tours
  const tours=[...$('#tours-tbody').rows].map(r=>({slot:r.cells[1].innerText.trim(),target:r.cells[2].innerText.trim(),actual:$('.t-actual',r).value||'',assign:r.querySelector('.tour-assign')?.value||'',checks:$$('.tck',r).map(c=>c.checked),temp:r.cells[12].querySelector('input').value||''}));
  // overstock
  const overstock=[...$('#overstock-tbody').rows].map(r=>({loc:$('.loc',r).value,upc:$('.upc',r).value,qty:Number($('.qty',r).value||0),action:$('.action',r).value,assign:r.querySelector('.overstock-assign')?.value||'',status:(r.querySelector('.status-display')?.innerText || r.querySelector('.status-select')?.value || '')}));
  // topstock
  const topstock=[...topA,...topB].map(id=>({id,ver:document.querySelector(`.ts-check[data-id="${id}"]`)?.checked||false,status:document.querySelector(`.ts-status[data-id="${id}"]`)?.value||'',notes:document.querySelector(`.ts-notes[data-id="${id}"]`)?.value||'',owner:document.querySelector(`.ts-owner[data-id="${id}"]`)?.value||''}));
  const coaching=loadLocal('coach_entries',[]);
  return {prefs,deptTargets,roster,roles,freight,zones,tours,overstock,topstock,coaching};
}
function restore(state){
  // prefs
  if(state?.prefs) saveLocal('wm_prefs', state.prefs);
  if(state?.deptTargets) saveLocal('wm_dept_targets', state.deptTargets);
  if(state?.roster) saveLocal('wm_roster', state.roster);
  if(state?.roles) saveLocal('wm_roles', state.roles);
  renderDeptTargets();
  renderRoster();
  // freight
  $('#freight-tbody').innerHTML=''; (state?.freight||[{},{},{}]).forEach(()=>addFreightRow());
  (state?.freight||[]).forEach((row,i)=>{const tr=$('#freight-tbody').rows[i]; if(!tr) return; $('.assoc',tr).value=row.assoc||''; $('.dept',tr).value=row.dept||departments[0]; $('.cin',tr).value=row.cin||''; $('.cout',tr).value=row.cout||''; $('.cases',tr).value=row.cases||0; $('.freight-assign',tr).value=row.assign||''; });
  recalcFreight();
  // zones
  initZones();
  if(state?.zones){ state.zones.forEach((z,i)=>{const tr=$('#zone-tbody').rows[i]; if(!tr) return; const inp=tr.cells[3].querySelector('.zcount'); const chk=tr.cells[3].querySelector('.zdone'); if(inp){inp.value=z.val; updateZoneRow(inp);} if(chk){chk.checked=Boolean(z.val); updateZoneRow(chk);} const asn=tr.querySelector('.zone-assign'); if(asn) asn.value=z.assign||''; }); }
  // tours
  initTours();
  if(state?.tours){ state.tours.forEach((t,i)=>{const tr=$('#tours-tbody').rows[i]; if(!tr) return; $('.t-actual',tr).value=t.actual||''; const cks=$$('.tck',tr); (t.checks||[]).forEach((v,ix)=>{ if(cks[ix]) cks[ix].checked=!!v; }); tr.cells[12].querySelector('input').value=t.temp||''; const asn=tr.querySelector('.tour-assign'); if(asn) asn.value=t.assign||''; updateTourRow($('.t-actual',tr)); }); }
  // overstock
  $('#overstock-tbody').innerHTML=''; (state?.overstock||[{},{},{}]).forEach(()=>addOverstockRow(false));
  (state?.overstock||[]).forEach((o,i)=>{const tr=$('#overstock-tbody').rows[i]; if(!tr) return; $('.loc',tr).value=o.loc||''; $('.upc',tr).value=o.upc||''; $('.qty',tr).value=o.qty||0; $('.action',tr).value=o.action||'Binned'; const sel=tr.querySelector('.status-select'); if(sel){ sel.value=o.status||'Pending'; colorOverstockStatus(sel); } const asn=tr.querySelector('.overstock-assign'); if(asn) asn.value=o.assign||''; });
  // coaching
  if(state?.coaching) saveLocal('coach_entries', state.coaching); renderCoachingList();
  // topstock
  initTopstock();
  if(state?.topstock){ state.topstock.forEach(ts=>{ const c=document.querySelector(`.ts-check[data-id="${ts.id}"]`); if(c) c.checked=!!ts.ver; const s=document.querySelector(`.ts-status[data-id="${ts.id}"]`); if(s) s.value=ts.status||''; const n=document.querySelector(`.ts-notes[data-id="${ts.id}"]`); if(n) n.value=ts.notes||''; const o=document.querySelector(`.ts-owner[data-id="${ts.id}"]`); if(o) o.value=ts.owner||''; }); updateTopstockProgress(); }
}

/* ===== Save / Load / Export / Clear / Print ===== */
function storageAvailable(){
  try{ const x='__wm_test__'; localStorage.setItem(x,'1'); localStorage.removeItem(x); return true; }catch(e){ return false; }
}

function ensureHiddenLoadInput(){
  let el=$('#hiddenLoadInput');
  if(!el){
    el=document.createElement('input'); el.type='file'; el.accept='application/json'; el.style.display='none'; el.id='hiddenLoadInput'; document.body.appendChild(el);
    el.onchange=function(){ const f=this.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ restore(JSON.parse(r.result)); logAction('Load dashboard','Loaded from backup file'); }catch(e){ alert('Invalid backup file.'); } }; r.readAsText(f); this.value=''; };
  }
  return el;
}

function initStorageButtons(){
  const clearBtn=$('#clearBtn');
  if(clearBtn) clearBtn.addEventListener('click',()=>{ if(confirm('Clear all tables (does not delete coaching)?')){ localStorage.removeItem('wm_dashboard_state'); restore({}); logAction('Clear dashboard data','Dashboard cleared'); } });
  else console.warn('initStorageButtons: #clearBtn not found');
}

function initClickActions(){
  const bindOnce = (id, handler, eventType='click') => {
    const el = $(id);
    if(!el) { console.warn(`initClickActions: ${id} not found`); return; }
    const flag = `bound_${eventType}`;
    if(el.dataset[flag] === '1') return;
    el.addEventListener(eventType, handler);
    el.dataset[flag] = '1';
  };

  bindOnce('#saveBtn', handleSave);
  bindOnce('#loadBtn', handleLoad);
  bindOnce('#printBtn', handlePrint);
  bindOnce('#exportBtn', handleExports);
  bindOnce('#settingsBtn', handleSettings);
  bindOnce('#closeSettingsBtn', ()=>toggleModal(false));
  bindOnce('#saveDeptTargetsBtn', saveDeptTargets);
  bindOnce('#settingsModal', e=>{ if(e.target===e.currentTarget) toggleModal(false); });

  bindOnce('#addFreightBtn', ()=>addFreightRow());
  bindOnce('#addOverstockBtn', ()=>addOverstockRow());
  bindOnce('#freight-tbody', e=>{ const btn=e.target.closest('.delete-row'); if(btn){ deleteRow(btn); logAction('Delete freight row','Removed freight row'); } });
  bindOnce('#overstock-tbody', e=>{ const btn=e.target.closest('.delete-row'); if(btn){ deleteRow(btn); logAction('Delete overstock row','Removed overstock row'); } });

  bindOnce('#markTopstockAll', ()=>markTopstockAll(true));
  bindOnce('#clearTopstockAll', ()=>markTopstockAll(false));
  bindOnce('#exportTopstock', ()=>exportTopstockCSV());
  bindOnce('#exportTopstockQuick', ()=>exportTopstockCSV());

  bindOnce('#saveCoachingBtn', saveCoaching);
  bindOnce('#exportCoachingBtn', exportCoaching);
  bindOnce('#clearCoachingBtn', clearCoaching);

  $$('.quick-export').forEach(btn=>btn.addEventListener('click',()=>exportTableCSV(btn.dataset.export)));
  bindOnce('#exportZonesBtn', ()=>exportZonesCSV());
  bindOnce('#exportToursBtn', ()=>exportToursCSV());

  bindOnce('#settingsModal .modal', e=>e.stopPropagation());

  bindOnce('#openExports', handleExportsModal);
  bindOnce('#closeExports', ()=>$('#exportsModal')?.classList.add('hidden'));
  bindOnce('#exportZonesModal', ()=>exportZonesCSV());
  bindOnce('#exportToursModal', ()=>exportToursCSV());
  bindOnce('#exportTopstockModal', ()=>exportTopstockCSV());
  bindOnce('#exportCoachingModal', ()=>exportCoaching());
  bindOnce('#exportShiftReport', exportShiftReport);

  bindOnce('#openHelp', handleShortcuts);
  bindOnce('#openHelp', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); handleShortcuts(); } }, 'keydown');
  bindOnce('#closeHelp', ()=>$('#helpModal')?.classList.add('hidden'));

  bindOnce('#health-pill', ()=>$('#healthInfoModal')?.classList.remove('hidden'));
  bindOnce('#closeHealthInfo', ()=>$('#healthInfoModal')?.classList.add('hidden'));

  document.addEventListener('click',e=>{ if(e.target.classList.contains('modal-backdrop')) e.target.classList.add('hidden'); });

  document.body.addEventListener('click',e=>{ const btn=e.target.closest('.history-btn'); if(btn){ $('#historyModal')?.classList.remove('hidden'); openHistory({type:btn.dataset.type, id:btn.dataset.zone||btn.dataset.slot}); }});
  bindOnce('#closeHistory', ()=>$('#historyModal')?.classList.add('hidden'));
  bindOnce('#historyStart', ()=>openHistory(), 'change');
  bindOnce('#historyEnd', ()=>openHistory(), 'change');
  bindOnce('#historyStatus', ()=>openHistory(), 'change');

  bindOnce('#markFreshComplete', ()=>{ if(confirm('Mark all fresh areas complete?')){ $('#tours-tbody').querySelectorAll('.tck').forEach(c=>c.checked=true); updateInsights(); }});
  bindOnce('#clockInFresh', ()=>{ const now=new Date(); const t=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; $('#tours-tbody').querySelectorAll('.t-actual').forEach(inp=>inp.value=t); updateCountdowns(); updateInsights(); });

  bindOnce('[data-jump="#coaching-embedded"]', ()=>document.querySelector('#coaching-embedded')?.scrollIntoView({behavior:'smooth'}));
}

function featureHighlight(el){
  if(!el) { console.warn('[featureHighlight] Element not found'); return; }
  el.classList.add('feature-highlight');
  el.scrollIntoView({behavior:'smooth', block:'center'});
  el.focus?.();
  setTimeout(()=>el.classList.remove('feature-highlight'), 1500);
}

function openFeatureModal(title, body){
  const modal=$('#featureModal');
  if(!modal) return;
  $('#featureTitle').textContent=title;
  $('#featureBody').textContent=body;
  modal.classList.remove('hidden');
  $('#closeFeature')?.focus();
}

/* ===== Action Handlers (Global) ===== */
function handleTheme(){
  const prefs = loadLocal('wm_prefs', {});
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  const next=isDark?'light':'dark';
  applyTheme(next);
  prefs.theme=next; saveLocal('wm_prefs',prefs);
  logAction('Toggle theme', next==='dark'?'Dark mode enabled':'Light mode enabled');
}
function handleSave(){
  try{
    const state=snapshot();
    let message='';
    if(storageAvailable()){ saveLocal('wm_dashboard_state', state); message='Saved to this device'; }
    else{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='wm_dashboard_state_backup.json'; document.body.appendChild(a); a.click(); a.remove(); message='Downloaded backup JSON'; }
    logAction('Save dashboard',message||'Dashboard saved');
  }catch(e){ alert('Save failed: '+e.message); console.error(e); }
}
function handleLoad(){
  try{
    if(storageAvailable()){
      const raw=localStorage.getItem('wm_dashboard_state');
      if(raw){ restore(JSON.parse(raw)); logAction('Load dashboard','Loaded saved state'); return; }
    }
    ensureHiddenLoadInput().click();
  }catch(e){ alert('Load failed: '+e.message); console.error(e); }
}
function handlePrint(){ window.print(); logAction('Print/PDF dashboard','Print/PDF triggered'); }
function handleSettings(){ toggleModal(true); }
function handleExports(){ 
  recordHistory(); 
  exportTableCSV('freight',false); 
  exportTableCSV('overstock',false); 
  exportZonesCSV(false); 
  exportToursCSV(false); 
  exportTopstockCSV(false); 
  logAction('Export all CSVs','All CSVs exported'); 
}
function handleExportsModal(){ $('#exportsModal')?.classList.remove('hidden'); }
function handleShortcuts(){ $('#helpModal')?.classList.remove('hidden'); }

function initToolbarActions(){
  const actions={
    'shift-roster':()=>{ const el=$('#rosterInput'); featureHighlight(el); toast('Add teammates to the roster'); },
    'closing-trainer':()=>{ const el=document.querySelector('[data-role="closing"]'); featureHighlight(el); toast('Assign a Closing Trainer'); },
    'freight-lead':()=>{ const el=document.querySelector('[data-role="freight"]'); featureHighlight(el); toast('Assign a Freight Lead'); },
    'zoning-lead':()=>{ const el=document.querySelector('[data-role="zoning"]'); featureHighlight(el); toast('Assign a Zoning Lead'); },
    'runner-utility':()=>{ const el=document.querySelector('[data-role="runner"]'); featureHighlight(el); toast('Assign a Runner/Utility'); },
    'calendar':()=>{ featureHighlight($('#shiftTimeline')); openFeatureModal('Calendar','Timeline markers visualize your shift. More calendar tools coming soon.'); },
    'health':()=>{ $('#healthInfoModal')?.classList.remove('hidden'); $('#closeHealthInfo')?.focus(); },
    'theme': handleTheme,
    'exports': handleExportsModal,
    'load': handleLoad,
    'save': handleSave,
    'print': handlePrint,
    'dept-targets': handleSettings,
    'shortcuts': handleShortcuts
  };
  const bind=(el)=>{
    if(el.dataset.bound === '1') return;
    const action=el.dataset.action;
    const handler=actions[action];
    if(!handler) { console.warn('[initToolbarActions] No handler found for action:', action); return; }
    const run=(e)=>{ e?.preventDefault?.(); handler(); };
    el.addEventListener('click', run);
    el.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); run(); } });
    el.dataset.bound = '1';
  };
  $$('[data-action]').forEach(bind);
  $('#closeFeature')?.addEventListener('click',()=>$('#featureModal')?.classList.add('hidden'));
}

/* ===== Init ===== */
function init(){
  initHeader(); initTabs(); renderDeptTargets(); renderRoster(); addFreightRow(); addFreightRow(); addFreightRow(); recalcFreight(); initZones(); initTours(); initStorageButtons(); initTopstock(); renderCoachingList(); initClickActions();
  setupBulk('#freight-tbody','#freight-bulk'); setupBulk('#zone-tbody','#zones-bulk'); setupBulk('#overstock-tbody','#overstock-bulk');
  initToolbarActions(); initShortcuts(); initNavHighlight(); initSwipeables(); initFab();
  const state=loadLocal('wm_dashboard_state', null); if(state) restore(state);
  updateCountdowns(); updateInsights(); updateHealth(); renderTimeline();
  setInterval(updateCountdowns,30000);
  const groups=$$('details.group'); const saved=loadLocal('wm_groups',{}); groups.forEach(g=>{ if(saved[g.dataset.group]===false) g.open=false; g.addEventListener('toggle',()=>{ saved[g.dataset.group]=g.open; saveLocal('wm_groups',saved); }); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ $$('.modal-backdrop').forEach(m=>m.classList.add('hidden')); } });
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
