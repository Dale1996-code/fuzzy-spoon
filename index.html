<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Walmart Academy Trainer Dashboard ‚Äî Pro (v3)</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --wm-blue:#0071ce;--wm-blue-dark:#004c87;--good:#00a651;--warn:#ffb81c;--bad:#e31837;
  --bg1:#f5f7fa;--bg2:#c3cfe2;--text:#1c2128;--card:#fff;--muted:#6c757d;
  --hd-pad:8px; --hd-fs:1.1rem; --hd-sub:.9rem;
}
[data-theme="dark"]{--bg1:#0f1115;--bg2:#151924;--text:#e9ecef;--card:#1b2130;--muted:#aab2c8}
body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);min-height:100vh;color:var(--text)}

/* ===== Header (not sticky by default) ===== */
.header{
  background:linear-gradient(135deg,var(--wm-blue) 0%,var(--wm-blue-dark) 100%);
  color:#fff;
  padding:var(--hd-pad) 10px;
  text-align:center;
  box-shadow:0 2px 6px rgba(0,0,0,.12);
}
.header h1{font-size:var(--hd-fs);line-height:1;margin-bottom:2px;text-shadow:1px 1px 3px rgba(0,0,0,.25)}
.header h2{font-weight:600;opacity:.95;font-size:var(--hd-sub)}
.header-info{
  width:100%;max-width:1400px;margin:6px auto 0;
  display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:nowrap;overflow:auto;
  scrollbar-width:none;
}
.header-info::-webkit-scrollbar{display:none}
.pill{background:rgba(255,255,255,.08);padding:4px 8px;border-radius:14px;backdrop-filter:blur(10px);display:flex;align-items:center;gap:6px;white-space:nowrap}
.pill input,.pill select{background:transparent;border:1px solid rgba(255,255,255,.35);color:#fff;padding:4px 6px;border-radius:6px;min-width:70px;font-size:.9rem}

/* OPTIONAL sticky mode (user controlled) */
body.is-sticky .header{position:sticky;top:0;z-index:50}
body.is-sticky .header.shrink{padding:6px 8px}
body.is-sticky .header.shrink h1{font-size:1rem}
body.is-sticky .header.shrink h2{display:none}

/* ===== Toolbar ===== */
.toolbar{
  max-width:1400px;margin:8px auto 0;padding:6px 12px;
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;
  background:rgba(255,255,255,.65);backdrop-filter:blur(8px);
  border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.08)
}
[data-theme="dark"] .toolbar{background:rgba(16,20,28,.6)}
.btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:.18s transform,.18s box-shadow;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
.btn-primary{background:var(--wm-blue);color:#fff}.btn-success{background:var(--good);color:#fff}
.btn-warning{background:var(--warn);color:#000}.btn-danger{background:var(--bad);color:#fff}
.btn-ghost{background:transparent;border:2px solid rgba(0,0,0,.15);color:inherit}
[data-theme="dark"] .btn-ghost{border-color:rgba(255,255,255,.25)}

/* ===== Tabs ===== */
.tabs{display:flex;max-width:1400px;margin:10px auto;padding:4px;background:#f0f2f6;border-radius:10px;gap:4px}
[data-theme="dark"] .tabs{background:#101522}
.tab{flex:1;padding:10px 16px;text-align:center;border-radius:8px;cursor:pointer;font-weight:800}
.tab.active{background:var(--wm-blue);color:#fff;box-shadow:0 2px 8px rgba(0,113,206,.35)}
.tab-content{display:none}.tab-content.active{display:block}

/* ===== Layout & Sections ===== */
.wrap{max-width:1400px;margin:0 auto;padding:12px}
.dashboard-container{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.section{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 8px 25px rgba(0,0,0,.10);transition:.25s transform,.25s box-shadow}
.section:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(0,0,0,.15)}
.section-header{display:flex;align-items:center;gap:10px;border-bottom:3px solid var(--wm-blue);padding-bottom:6px;margin-bottom:10px}
.section-header h2{color:var(--wm-blue);font-size:1.1rem}
.full-width{grid-column:1/-1}
.right{text-align:right}.muted{color:var(--muted)}

table{width:100%;border-collapse:collapse}
th{background:#f6f7fb;padding:8px;text-align:left;border-bottom:2px solid #dfe3ea;font-size:.9em}
td{padding:8px;border-bottom:1px solid #e3e7ef;font-size:.9em}
tr:hover{background:#f8f9fb}
.input-field{width:100%;padding:6px 8px;border:2px solid #e9ecef;border-radius:6px;background:transparent;color:inherit}
.input-field:focus{outline:none;border-color:var(--wm-blue);box-shadow:0 0 0 3px rgba(0,113,206,.15)}
.checkbox{width:18px;height:18px;accent-color:var(--wm-blue)}
.status-badge{padding:4px 10px;border-radius:20px;font-size:.8em;font-weight:800;display:inline-block;min-width:84px;text-align:center}
.status-excellent{background:#d4edda;color:#155724}.status-good{background:#d1ecf1;color:#0c5460}
.status-warning{background:#fff3cd;color:#856404}.status-danger{background:#f8d7da;color:#721c24}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:8px}
.kpi-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:14px;border-radius:12px;text-align:center;position:relative;overflow:hidden}
.kpi-card::before{content:"";position:absolute;inset:0;background:rgba(255,255,255,.1);transform:translateX(-100%);transition:transform .6s}
.kpi-card:hover::before{transform:translateX(100%)}
.kpi-value{font-size:1.6rem;font-weight:800}.kpi-label{font-size:.9rem;opacity:.9}.kpi-target{font-size:.8rem;opacity:.85;margin-top:4px}
.progress-bar{width:100%;height:18px;background:#e9ecef;border-radius:10px;overflow:hidden;margin:6px 0}
.progress-fill{height:100%;background:linear-gradient(90deg,#00a651 0%,#4CAF50 100%);transition:width .5s;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.8em;font-weight:800}

/* Mobile */
@media (max-width:900px){
  .dashboard-container{grid-template-columns:1fr}
}

/* Print */
@media print{
  *{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  body{background:#fff;color:#000}
  .header{position:static !important;box-shadow:none !important}
  .tabs,.toolbar,.btn,label[for],input[type=file],#settingsModal{display:none !important}
  .section{box-shadow:none !important;border:1px solid #ddd}
}
@page{size:auto;margin:12mm}
</style>
</head>
<body>
<!-- HEADER (not sticky; can be pinned) -->
<div class="header" id="hdr">
  <h1>üè™ WALMART NEIGHBORHOOD MARKET</h1>
  <h2>Salesfloor Academy Trainer Dashboard ‚Äî Pro</h2>
  <div class="header-info">
    <div class="pill">üìÖ <span id="current-date"></span></div>
    <div class="pill">üë§ <label for="trainer-name" style="opacity:.85">Trainer:</label> <input id="trainer-name" placeholder="Enter name"/></div>
    <div class="pill">‚è∞ <label for="shift-select" style="opacity:.85">Shift:</label> <select id="shift-select"><option>Opening</option><option>Mid</option><option selected>Closing</option></select></div>
    <div class="pill">üè™ <label for="store-number" style="opacity:.85">Store #:</label> <input id="store-number" placeholder="####" style="width:72px"/></div>
    <div class="pill">üéØ <label for="target-cph" style="opacity:.85">Target CPH:</label> <input id="target-cph" type="number" min="1" value="45" style="width:80px"/></div>
    <div class="pill"><button class="btn btn-ghost" id="themeBtn">üåì Theme</button></div>
  </div>
</div>

<!-- Toolbar -->
<div class="toolbar">
  <button class="btn btn-primary" id="saveBtn">üíæ Save</button>
  <button class="btn btn-success" id="loadBtn">üìÇ Load</button>
  <button class="btn btn-warning" id="exportBtn">‚¨áÔ∏è Export CSVs</button>
  <button class="btn btn-danger" id="clearBtn">üßπ Clear</button>
  <button class="btn" id="printBtn">üñ®Ô∏è Print / PDF</button>
  <button class="btn" id="settingsBtn">‚öôÔ∏è Dept Targets</button>
  <button class="btn btn-ghost" id="pinHeaderBtn" title="Toggle sticky header">üìå Pin header</button>
  <label class="btn">üì• Import Roster CSV <input type="file" id="importRoster" accept=".csv" style="display:none"/></label>
  <label class="btn">üì• Import Overstock CSV <input type="file" id="importOverstock" accept=".csv" style="display:none"/></label>
  <span class="muted" style="font-size:.9rem">Tip: header does not scroll unless you pin it.</span>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" data-tab="dashboard">üìä Daily Dashboard</div>
  <div class="tab" data-tab="coaching">üë• Coaching Tracker</div>
  <div class="tab" data-tab="reports">üìà Reports</div>
</div>

<div class="wrap">
  <!-- DASHBOARD -->
  <div id="dashboard" class="tab-content active">
    <div class="dashboard-container">
      <div class="section">
        <div class="section-header"><span>üì¶</span><h2>Freight Performance Tracker</h2></div>
        <div class="muted" style="margin-bottom:6px">Uses <strong>department targets</strong> if set; otherwise global target (<span id="kpi-target-cph">45</span>).</div>
        <table id="freight-table">
          <thead><tr><th>Associate</th><th>Department</th><th>Clock In</th><th>Clock Out</th><th>Cases</th><th>Hours</th><th>Cases/Hr</th><th>Status</th><th class="right">‚ãØ</th></tr></thead>
          <tbody id="freight-tbody"></tbody>
        </table>
        <div class="right" style="margin-top:6px"><button class="btn btn-primary" onclick="addFreightRow()">Ôºã Add Row</button></div>
        <div class="kpi-grid">
          <div class="kpi-card"><div class="kpi-value" id="kpi-total-cases">0</div><div class="kpi-label">Total Cases</div></div>
          <div class="kpi-card"><div class="kpi-value" id="kpi-total-hours">0.0</div><div class="kpi-label">Total Hours</div></div>
          <div class="kpi-card"><div class="kpi-value" id="kpi-avg-cph">0.0</div><div class="kpi-label">Avg Cases/Hr</div></div>
        </div>
        <div class="section" style="margin-top:10px">
          <div class="section-header" style="border-bottom:none"><span>‚öôÔ∏è</span><h2 style="border:0">Department Targets (CPH)</h2></div>
          <div id="dept-targets" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px"></div>
        </div>
        <div class="section" style="margin-top:10px">
          <div class="section-header"><span>üì¢</span><h2>Team Summary</h2></div>
          <div class="muted" id="team-summary" style="padding:6px 0">Enter data to see team performance</div>
        </div>
      </div>

      <div class="section">
        <div class="section-header"><span>üè™</span><h2>Zone Verification Status</h2></div>
        <table id="zone-table">
          <thead><tr><th>Zone</th><th>Total Aisles</th><th>Completed</th><th>% Complete</th><th>Status</th></tr></thead>
          <tbody id="zone-tbody"></tbody>
        </table>
        <div class="progress-bar"><div class="progress-fill" id="zone-progress" style="width:0%">0% Complete</div></div>
      </div>

      <div class="section full-width">
        <div class="section-header"><span>ü•¨</span><h2>Fresh Area Tour Schedule</h2></div>
        <table id="tours-table">
          <thead><tr><th>Time Slot</th><th>Target Time</th><th>Actual Time</th><th>Produce</th><th>Meat</th><th>Deli</th><th>Bakery</th><th>Dairy</th><th>Frozen</th><th>Temp Check</th><th>Status</th></tr></thead>
          <tbody id="tours-tbody"></tbody>
        </table>
      </div>

      <div class="section">
        <div class="section-header"><span>üìã</span><h2>Overstock & Inventory Log</h2></div>
        <table id="overstock-table">
          <thead><tr><th>Location</th><th>Item/UPC</th><th>Qty</th><th>Action</th><th>Status</th><th class="right">‚ãØ</th></tr></thead>
        <tbody id="overstock-tbody"></tbody>
        </table>
        <div class="right" style="margin-top:6px"><button class="btn btn-primary" onclick="addOverstockRow()">Ôºã Add Item</button></div>
      </div>

      <div class="section full-width">
        <div class="section-header"><span>üóÇÔ∏è</span><h2>Top-Stock A/B Aisles Compliance (30 aisles)</h2></div>
        <div class="muted">Quick pass: A1‚ÄìA20 (Dry Grocery), B1‚ÄìB10 (Consumables).</div>
        <div class="progress-bar"><div class="progress-fill" id="topstock-progress" style="width:0%">0% Verified</div></div>
        <div id="topstock-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-top:8px"></div>
        <div class="right" style="margin-top:6px">
          <button class="btn btn-success" onclick="markTopstockAll(true)">Mark All Verified</button>
          <button class="btn btn-warning" onclick="markTopstockAll(false)">Clear All</button>
          <button class="btn btn-primary" onclick="exportTopstockCSV()">Export Top-Stock CSV</button>
        </div>
      </div>
    </div>
  </div>

  <!-- COACHING -->
  <div id="coaching" class="tab-content">
    <div class="dashboard-container" style="grid-template-columns:1fr;">
      <div class="section coaching-form">
        <div class="section-header"><span>üìù</span><h2>Coaching Tracker</h2></div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px">
          <div class="form-group"><label>Associate Name</label><input class="input-field" id="coach-assoc" placeholder="Full name"/></div>
          <div class="form-group"><label>Department</label>
            <select class="input-field" id="coach-dept">
              <option>Dry Grocery</option><option>Consumables</option><option>Produce</option>
              <option>Meat</option><option>Deli/Bakery</option><option>Dairy</option><option>Frozen</option>
            </select>
          </div>
        </div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px">
          <div class="form-group">
            <label>Issues</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:6px 0">
              <label><input type="checkbox" class="checkbox coach-issue" value="Attendance"/> Attendance</label>
              <label><input type="checkbox" class="checkbox coach-issue" value="Productivity"/> Productivity</label>
              <label><input type="checkbox" class="checkbox coach-issue" value="Zoning"/> Zoning</label>
              <label><input type="checkbox" class="checkbox coach-issue" value="Backroom/Top-Stock"/> Backroom/Top-Stock</label>
              <label><input type="checkbox" class="checkbox coach-issue" value="Fresh Area Compliance"/> Fresh Area Compliance</label>
              <label><input type="checkbox" class="checkbox coach-issue" value="Other"/> Other</label>
            </div>
          </div>
          <div class="form-group"><label>Follow-up Date</label><input class="input-field" type="date" id="coach-follow"/></div>
        </div>
        <div class="form-group"><label>Goals</label><textarea class="input-field" id="coach-goals" rows="3" placeholder="Specific, measurable goals..."></textarea></div>
        <div class="form-group"><label>Notes</label><textarea class="input-field" id="coach-notes" rows="3" placeholder="Observations, expectations, support..."></textarea></div>
        <div class="right">
          <button class="btn btn-success" onclick="saveCoaching()">Save Entry</button>
          <button class="btn btn-primary" onclick="exportCoaching()">Export CSV</button>
          <button class="btn btn-warning" onclick="clearCoaching()">Clear Saved</button>
        </div>
        <div class="section" style="margin-top:10px">
          <div class="section-header" style="border-bottom:none"><span>üì¶</span><h2 style="border:0">Saved Items</h2></div>
          <div id="coaching-list" style="margin-top:6px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- REPORTS -->
  <div id="reports" class="tab-content">
    <div class="dashboard-container" style="grid-template-columns:1fr 1fr;">
      <div class="section">
        <div class="section-header"><span>üìà</span><h2>Cases/Hr by Associate</h2></div>
        <canvas id="chart-cph" width="600" height="320" style="width:100%"></canvas>
        <div class="muted">Updates from Freight data.</div>
      </div>
      <div class="section">
        <div class="section-header"><span>üìä</span><h2>Zone Completion by Area</h2></div>
        <canvas id="chart-zones" width="600" height="320" style="width:100%"></canvas>
        <div class="muted">Shows % complete in Zone Verification.</div>
      </div>
      <div class="section full-width">
        <div class="section-header"><span>üßæ</span><h2>Quick Exports</h2></div>
        <div class="right" style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="exportTableCSV('freight')">Export Freight CSV</button>
          <button class="btn btn-primary" onclick="exportTableCSV('overstock')">Export Overstock CSV</button>
          <button class="btn btn-primary" onclick="exportZonesCSV()">Export Zones CSV</button>
          <button class="btn btn-primary" onclick="exportToursCSV()">Export Tours CSV</button>
          <button class="btn btn-primary" onclick="exportTopstockCSV()">Export Top-Stock CSV</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px">
  <div style="background:var(--card);color:var(--text);max-width:640px;width:100%;border-radius:12px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.25)">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <h3>Department Target Cases/Hr</h3>
      <button class="btn btn-danger" onclick="toggleModal(false)">Close</button>
    </div>
    <div id="modal-targets" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:6px"></div>
    <div class="right" style="margin-top:10px">
      <button class="btn btn-success" onclick="saveDeptTargets()">Save Targets</button>
    </div>
    <div class="muted" style="margin-top:8px">Leave blank to use the global target.</div>
  </div>
</div>

<script>
/* ===== Utilities ===== */
const $=(q,ctx=document)=>ctx.querySelector(q);const $$=(q,ctx=document)=>Array.from(ctx.querySelectorAll(q));
function toMinutes(t){if(!t)return 0;const [h,m]=t.split(':').map(Number);return h*60+m}
function hoursBetween(start,end){if(!start||!end)return 0;let s=toMinutes(start),e=toMinutes(end);if(e<s)e+=1440;return (e-s)/60}
function fmt(n,d=1){return (isFinite(n)?Number(n).toFixed(d):'0')}
function saveLocal(k,d){localStorage.setItem(k,JSON.stringify(d))}
function loadLocal(k,f){try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}}
function download(filename,text){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([text],{type:'text/csv'}));a.download=filename;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove()},0)}
function toast(msg){const t=document.createElement('div');t.textContent=msg;t.style.cssText='position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:10px 14px;border-radius:8px;z-index:9999;font:600 14px system-ui,Segoe UI,sans-serif;';document.body.appendChild(t);setTimeout(()=>{t.style.opacity=0;t.style.transition="opacity .3s"},1200);setTimeout(()=>t.remove(),1600)}

/* ===== Header / Theme / Pin ===== */
const departments=['Dry Grocery','Consumables','Dairy','Frozen','Produce','Meat','Deli/Bakery'];
function initHeader(){
  const now=new Date();$('#current-date').textContent=now.toLocaleString([], {weekday:'short', month:'short', day:'numeric', year:'numeric'});
  const prefs = loadLocal('wm_prefs', {});
  $('#trainer-name').value=prefs.trainer||'';$('#shift-select').value=prefs.shift||'Closing';$('#store-number').value=prefs.store||'';
  $('#target-cph').value=prefs.targetCPH ?? 45; $('#kpi-target-cph').textContent=$('#target-cph').value;
  if(prefs.theme==='dark') document.documentElement.setAttribute('data-theme','dark');
  if(prefs.pinHeader) document.body.classList.add('is-sticky');
  $('#pinHeaderBtn').textContent = document.body.classList.contains('is-sticky') ? 'üìå Unpin header' : 'üìå Pin header';
  $('#pinHeaderBtn').addEventListener('click',()=>{
    document.body.classList.toggle('is-sticky');
    const p=loadLocal('wm_prefs',{}); p.pinHeader=document.body.classList.contains('is-sticky'); saveLocal('wm_prefs',p);
    $('#pinHeaderBtn').textContent = p.pinHeader ? 'üìå Unpin header' : 'üìå Pin header';
  });
  $('#themeBtn').addEventListener('click',()=>{
    const isDark=document.documentElement.getAttribute('data-theme')==='dark';
    document.documentElement.setAttribute('data-theme',isDark?'':'dark');
    prefs.theme=isDark?'':'dark'; saveLocal('wm_prefs',prefs)
  });
  ['trainer-name','shift-select','store-number','target-cph'].forEach(id=>$('#'+id).addEventListener('change',()=>{
    const p=loadLocal('wm_prefs',{});
    p.trainer=$('#trainer-name').value;p.shift=$('#shift-select').value;p.store=$('#store-number').value;p.targetCPH=Number($('#target-cph').value)||45;
    $('#kpi-target-cph').textContent=p.targetCPH; saveLocal('wm_prefs',p); recalcFreight();
  }));
  // if pinned, add shrink on scroll
  function onScroll(){ if(document.body.classList.contains('is-sticky')){ const hdr=$('#hdr'); if(window.scrollY>40) hdr.classList.add('shrink'); else hdr.classList.remove('shrink'); } }
  document.addEventListener('scroll', onScroll, {passive:true}); onScroll();
}

/* ===== Tabs ===== */
function initTabs(){$$('.tab').forEach(t=>t.addEventListener('click',()=>{$$('.tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');const tab=t.getAttribute('data-tab');$$('.tab-content').forEach(c=>c.classList.remove('active'));$('#'+tab).classList.add('active');if(tab==='reports') drawCharts();}))}

/* ===== Dept targets ===== */
function renderDeptTargets(){
  const state = loadLocal('wm_dept_targets', {});
  const wrap = $('#dept-targets'); wrap.innerHTML='';
  departments.forEach(d=>{
    const v = state[d] ?? '';
    wrap.insertAdjacentHTML('beforeend', `<label style="display:flex;gap:6px;align-items:center"><span style="background:#e9ecef;color:#495057;padding:2px 8px;border-radius:12px;font-size:.75em;font-weight:700">${d}</span><input class="input-field dt" data-dept="${d}" type="number" min="1" placeholder="‚Äî" value="${v!==''?v:''}" style="width:90px"/></label>`);
  });
}
function toggleModal(show=true){
  const m=$('#settingsModal'); m.style.display = show ? 'flex' : 'none';
  if(show){
    const box=$('#modal-targets'); box.innerHTML='';
    const current=loadLocal('wm_dept_targets', {});
    departments.forEach(d=>{
      const v=current[d]??'';
      box.insertAdjacentHTML('beforeend',`<div><div style="background:#e9ecef;color:#495057;padding:2px 8px;border-radius:12px;display:inline-block;font-size:.8rem;font-weight:700">${d}</div><input class="input-field modal-dt" data-dept="${d}" type="number" min="1" placeholder="‚Äî" value="${v!==''?v:''}" style="margin-top:6px"/></div>`);
    });
  }
}
function saveDeptTargets(){
  const obj={}; $$('.modal-dt').forEach(i=>{ const val=i.value.trim(); if(val!=='') obj[i.dataset.dept]=Number(val)});
  saveLocal('wm_dept_targets', obj); renderDeptTargets(); recalcFreight(); toggleModal(false);
}
$('#settingsBtn').addEventListener?.('click', ()=>toggleModal(true));

/* ===== Freight ===== */
function freightRowTemplate(){
  return `<tr>
    <td><input class="input-field assoc" placeholder="Associate Name"/></td>
    <td><select class="input-field dept">${departments.map(d=>`<option>${d}</option>`).join('')}</select></td>
    <td><input type="time" class="input-field cin"/></td>
    <td><input type="time" class="input-field cout"/></td>
    <td><input type="number" min="0" class="input-field cases" placeholder="0"/></td>
    <td class="hours-cell">0.0</td>
    <td class="caseshr-cell">0.0</td>
    <td class="status-cell"><span class="status-badge">Pending</span></td>
    <td class="right"><button class="btn btn-danger btn-sm" onclick="deleteRow(this)">‚úñ</button></td>
  </tr>`;
}
function addFreightRow(){ $('#freight-tbody').insertAdjacentHTML('beforeend', freightRowTemplate()); hookFreightInputs() }
function hookFreightInputs(){ $('#freight-tbody').querySelectorAll('input,select').forEach(el=>el.onchange=recalcFreight) }
function deleteRow(el){ el.closest('tr').remove(); recalcFreight() }
function badgeForCPH(cph, dept){
  const deptTargets = loadLocal('wm_dept_targets', {});
  const globalTarget = Number($('#target-cph').value)||45;
  const target = Number(deptTargets[dept]) || globalTarget;
  if(isNaN(cph)||!isFinite(cph)||cph<=0) return ['status-badge','Pending'];
  if(cph >= target*1.15) return ['status-badge status-excellent', `${fmt(cph)} ‚≠ê`];
  if(cph >= target) return ['status-badge status-good', `${fmt(cph)} ‚úÖ`];
  if(cph >= target*0.75) return ['status-badge status-warning', `${fmt(cph)} ‚ö†Ô∏è`];
  return ['status-badge status-danger', `${fmt(cph)} ‚ùå`];
}
function recalcFreight(){
  const rows=[...$('#freight-tbody').rows]; let totalCases=0,totalHours=0, good=0;
  rows.forEach(r=>{
    const dept=$('.dept',r).value;
    const cases=Number($('.cases',r).value)||0;
    const h=hoursBetween($('.cin',r).value,$('.cout',r).value);
    const cph=h>0?cases/h:0;
    totalCases+=cases; totalHours+=h;
    $('.hours-cell',r).textContent=fmt(h);
    $('.caseshr-cell',r).textContent=fmt(cph);
    const [cls,label]=badgeForCPH(cph, dept);
    $('.status-cell',r).innerHTML=`<span class="${cls}">${label}</span>`;
    const deptTargets = loadLocal('wm_dept_targets', {});
    const target = Number(deptTargets[dept]) || (Number($('#target-cph').value)||45);
    if(cph >= target) good++;
  });
  const teamCPH = totalHours>0? totalCases/totalHours : 0;
  $('#kpi-total-cases').textContent=totalCases; $('#kpi-total-hours').textContent=fmt(totalHours); $('#kpi-avg-cph').textContent=fmt(teamCPH);
  $('#team-summary').textContent=`Team CPH ${fmt(teamCPH)} ‚Ä¢ ${good}/${rows.length} meeting dept/global targets ‚Ä¢ Total ${totalCases} cases in ${fmt(totalHours)} hrs.`;
  drawCharts();
}

/* ===== CSV Imports ===== */
function parseCSV(text){
  const lines=text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length);
  const headers=lines.shift().split(',').map(h=>h.trim().toLowerCase());
  const rows=lines.map(l=>{
    const parts=[]; let cur='',inQ=false;
    for(let i=0;i<l.length;i++){
      const ch=l[i];
      if(ch=='"'){ if(l[i+1]=='"'){cur+='"'; i++;} else { inQ=!inQ; } }
      else if(ch===',' && !inQ){ parts.push(cur); cur=''; }
      else{ cur+=ch; }
    }
    parts.push(cur);
    const obj={};
    headers.forEach((h,idx)=>obj[h]=parts[idx]?.trim()||'');
    return obj;
  });
  return {headers, rows};
}
$('#importRoster').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader(); reader.onload=()=>{
    const {rows}=parseCSV(reader.result);
    rows.forEach(r=>{
      addFreightRow();
      const tr=$('#freight-tbody').lastElementChild;
      $('.assoc',tr).value = r['associate'] || r['name'] || '';
      $('.dept',tr).value = r['department'] || departments[0];
      $('.cin',tr).value = r['clock in'] || r['clockin'] || r['in'] || '';
      $('.cout',tr).value = r['clock out'] || r['clockout'] || r['out'] || '';
      $('.cases',tr).value = r['cases'] || r['case'] || 0;
    });
    recalcFreight();
    e.target.value='';
  };
  reader.readAsText(f);
});
$('#importOverstock').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader(); reader.onload=()=>{
    const {rows}=parseCSV(reader.result);
    rows.forEach(r=>{
      addOverstockRow();
      const tr=$('#overstock-tbody').lastElementChild;
      $('.loc',tr).value = r['location']||'';
      $('.upc',tr).value = r['item/upc']||r['upc']||r['item']||'';
      $('.qty',tr).value = r['qty']||r['quantity']||0;
      $('.action',tr).value = r['action']||'Binned';
      const st = (r['status']||'Pending');
      const td=tr.cells[4];
      td.innerHTML=`<span class="status-badge ${st==='Done'?'status-excellent':(st==='In Progress'?'status-good':'status-danger')}">${st}</span>`;
    });
    e.target.value='';
  };
  reader.readAsText(f);
});

/* ===== Zones ===== */
const zoneDefaults=[{name:'Dry Grocery',total:14,type:'count'},{name:'Consumables',total:10,type:'count'},
{name:'Produce',total:1,type:'check'},{name:'Meat',total:1,type:'check'},{name:'Deli/Bakery',total:1,type:'check'},
{name:'Dairy',total:3,type:'count'},{name:'Frozen',total:4,type:'count'}];
function initZones(){
  const tb=$('#zone-tbody'); tb.innerHTML='';
  zoneDefaults.forEach(z=>{
    const completedInput = z.type==='check' ? `<input type="checkbox" class="checkbox zdone" data-total="${z.total}"/>`
      : `<input type="number" class="input-field zcount" min="0" max="${z.total}" value="0" data-total="${z.total}"/>`;
    tb.insertAdjacentHTML('beforeend', `<tr>
      <td><span style="background:#e9ecef;color:#495057;padding:2px 8px;border-radius:12px;font-size:.75em;font-weight:700">${z.name}</span></td>
      <td>${z.total}</td><td>${completedInput}</td><td class="zone-percent">0%</td>
      <td class="zone-status"><span class="status-badge status-danger">‚ùå Incomplete</span></td></tr>`);
  });
  tb.querySelectorAll('.zcount').forEach(i=>i.onchange=()=>updateZoneRow(i));
  tb.querySelectorAll('.zdone').forEach(i=>i.onchange=()=>updateZoneRow(i));
  updateZoneTotals();
}
function zoneStatus(pct){ if(pct>=100) return ['‚úÖ Complete','status-badge status-excellent']; if(pct>=75) return ['üü° On Track','status-badge status-good']; if(pct>0) return ['‚ö†Ô∏è In Progress','status-badge status-warning']; return ['‚ùå Incomplete','status-badge status-danger'] }
function updateZoneRow(input){
  const tr=input.closest('tr'); const total=Number(input.dataset.total)||1;
  const done = input.classList.contains('zcount') ? Math.max(0,Math.min(total, Number(input.value)||0)) : (input.checked?1:0);
  const pct=Math.round((done/total)*100);
  $('.zone-percent',tr).textContent=pct+'%'; const [text,cls]=zoneStatus(pct); $('.zone-status',tr).innerHTML=`<span class="${cls}">${text}</span>`; updateZoneTotals();
}
function updateZoneTotals(){
  const rows=[...$('#zone-tbody').rows]; let totalA=0,totalD=0;
  rows.forEach(r=>{const total=Number(r.cells[1].textContent)||1; totalA+=total; const pct=Number(r.cells[3].textContent.replace('%',''))||0; totalD+=Math.round(pct*total/100)});
  const overall=Math.round((totalD/totalA)*100)||0; $('#zone-progress').style.width=overall+'%'; $('#zone-progress').textContent=overall+'% Complete'; drawCharts();
}

/* ===== Tours ===== */
const tourSlots=[['Opening Walk','06:30'],['Mid-Morning','10:00'],['Lunch Check','13:00'],['Afternoon','16:00'],['Evening','19:00']];
function initTours(){
  const tb=$('#tours-tbody'); tb.innerHTML='';
  tourSlots.forEach(([label,target])=>{
    tb.insertAdjacentHTML('beforeend', `<tr>
      <td><strong>${label}</strong></td><td>${target}</td>
      <td><input type="time" class="input-field t-actual"/></td>
      <td><input type="checkbox" class="checkbox tck"/></td>
      <td><input type="checkbox" class="checkbox tck"/></td>
      <td><input type="checkbox" class="checkbox tck"/></td>
      <td><input type="checkbox" class="checkbox tck"/></td>
      <td><input type="checkbox" class="checkbox tck"/></td>
      <td><input type="checkbox" class="checkbox tck"/></td>
      <td><input type="text" class="input-field t-temp" placeholder="¬∞F"/></td>
      <td class="tour-status"><span class="time-indicator" style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#ffb81c;margin-right:6px"></span>Pending</td>
    </tr>`);
  });
  $('#tours-tbody').querySelectorAll('.t-actual').forEach(i=>i.onchange=()=>updateTourRow(i));
  $('#tours-tbody').querySelectorAll('.tck').forEach(i=>i.onchange=()=>updateTourRow(i));
}
function updateTourRow(input){
  const tr=input.closest('tr'); const target=tr.cells[1].textContent.trim(); const actual=$('.t-actual',tr).value;
  const checks=$$('.tck',tr); const allDone=checks.length && checks.every(c=>c.checked);
  let statusText='Pending', color='#ffb81c';
  if(actual){ const diff=Math.abs(toMinutes(actual)-toMinutes(target)); if(diff<=20){statusText='On Time'; color='#00a651'} else if(diff<=45){statusText='Late'; color='#ffb81c'} else {statusText='Overdue'; color='#e31837'} }
  if(allDone && actual){ statusText+=' ‚Ä¢ All checks done' }
  tr.querySelector('.tour-status').innerHTML = `<span class="time-indicator" style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${color};margin-right:6px"></span>${statusText}`;
}
function exportToursCSV(){
  const rows=[...$('#tours-tbody').rows];
  const headers=['Slot','Target','Actual','Produce','Meat','Deli','Bakery','Dairy','Frozen','Temp','Status'];
  const csv=[headers.join(',')].concat(rows.map(r=>{
    const vals=[r.cells[0].innerText.trim(),r.cells[1].innerText.trim(),$('.t-actual',r).value||'',...$$('.tck',r).map(c=>c.checked?'‚úî':''),r.cells[9].querySelector('input').value||'',r.cells[10].innerText.trim()];
    return vals.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
  })).join('\n'); download('tours.csv',csv);
}

/* ===== Overstock ===== */
function overstockRowTemplate(){
  return `<tr>
    <td><input class="input-field loc" placeholder="Aisle/Section"/></td>
    <td><input class="input-field upc" placeholder="UPC or Description"/></td>
    <td><input class="input-field qty" type="number" min="0" placeholder="0"/></td>
    <td><select class="input-field action"><option>Binned</option><option>Flexed</option><option>Worked</option><option>RTV</option><option>Claims</option></select></td>
    <td><select class="input-field status" onchange="colorOverstockStatus(this)"><option>Pending</option><option>In Progress</option><option>Done</option></select></td>
    <td class="right"><button class="btn btn-danger" onclick="deleteRow(this)">‚úñ</button></td>
  </tr>`;
}
function addOverstockRow(){ $('#overstock-tbody').insertAdjacentHTML('beforeend', overstockRowTemplate()) }
function colorOverstockStatus(sel){
  const td=sel.closest('td'); let cls='status-badge status-warning', txt=sel.value;
  if(sel.value==='Done') cls='status-badge status-excellent'; else if(sel.value==='In Progress') cls='status-badge status-good'; else cls='status-badge status-danger';
  td.innerHTML=`<span class="${cls}">${txt}</span>`;
}
function exportTableCSV(which){
  let rows=[], headers=[];
  if(which==='freight'){
    headers=['Associate','Department','Clock In','Clock Out','Cases','Hours','Cases/Hr','Status'];
    rows=[...$('#freight-tbody').rows].map(r=>[$('.assoc',r).value,$('.dept',r).value,$('.cin',r).value,$('.cout',r).value,$('.cases',r).value,r.cells[5].innerText.trim(),r.cells[6].innerText.trim(),r.cells[7].innerText.trim()]);
  }else if(which==='overstock'){
    headers=['Location','Item/UPC','Qty','Action','Status'];
    rows=[...$('#overstock-tbody').rows].map(r=>[$('.loc',r).value,$('.upc',r).value,$('.qty',r).value,$('.action',r).value,(r.cells[4].querySelector('span')?.innerText || $('.status',r)?.value || '')]);
  }
  const csv=[headers.join(',')].concat(rows.map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','))).join('\n'); download(`${which}.csv`,csv);
}
function exportZonesCSV(){
  const headers=['Zone','Total','Completed','Percent','Status'];
  const csv=[headers.join(',')].concat([...$('#zone-tbody').rows].map(r=>{
    const zone=r.cells[0].innerText.trim(), total=r.cells[1].innerText.trim();
    const compCell=r.cells[2]; const comp=(compCell.querySelector('.zcount')?.value) ?? (compCell.querySelector('.zdone')?.checked ? '1' : '0');
    const pct=r.cells[3].innerText.trim(); const st=r.cells[4].innerText.trim();
    return [zone,total,comp,pct,st].map(v=>`"${v}"`).join(',');
  })).join('\n'); download('zones.csv',csv);
}

/* ===== Coaching save/export ===== */
function getCoachingForm(){
  const issues=$$('.coach-issue:checked').map(c=>c.value);
  return {associate:$('#coach-assoc').value.trim(),dept:$('#coach-dept').value,follow:$('#coach-follow').value,goals:$('#coach-goals').value.trim(),notes:$('#coach-notes').value.trim(),issues};
}
function saveCoaching(){ const entry=getCoachingForm(); const list=loadLocal('coach_entries',[]); list.push({...entry, ts:new Date().toISOString()}); saveLocal('coach_entries',list); renderCoachingList(); toast('Coaching saved') }
function renderCoachingList(){
  const box=$('#coaching-list'); box.innerHTML=''; const list=loadLocal('coach_entries',[]);
  if(!list.length){ box.textContent='No entries yet.'; return; }
  list.forEach((e,i)=>{
    const div=document.createElement('div'); div.style.padding='8px 0';
    const date=new Date(e.ts).toLocaleString();
    div.innerHTML=`#${i+1} ‚Ä¢ ${date} ‚Ä¢ <strong>${e.associate}</strong> (${e.dept}) ‚Ä¢ Issues: ${e.issues.join(', ')||'‚Äî'} `;
    box.appendChild(div);
  });
}
function exportCoaching(){
  const list=loadLocal('coach_entries',[]);
  const headers=['Timestamp','Associate','Dept','Issues','Follow-Up','Goals','Notes'];
  const csv=[headers.join(',')].concat(list.map(e=>[e.ts,e.associate,e.dept,(e.issues||[]).join('; '),e.follow,e.goals,e.notes].map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','))).join('\n');
  download('coaching.csv',csv);
}
function clearCoaching(){ localStorage.removeItem('coach_entries'); renderCoachingList(); toast('Coaching cleared') }

/* ===== Top-Stock Checklist ===== */
const topA = Array.from({length:20}, (_,i)=>`A${i+1}`);
const topB = Array.from({length:10}, (_,i)=>`B${i+1}`);
function initTopstock(){
  const grid=$('#topstock-grid'); grid.innerHTML='';
  const makeCard=(id)=>`
    <div style="border:1px solid #dfe3ea;border-radius:10px;padding:8px">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <strong>${id}</strong>
        <select class="input-field ts-status" data-id="${id}" style="width:120px">
          <option value="Verified">Verified</option>
          <option value="Needs Work">Needs Work</option>
          <option value="Blocked">Blocked</option>
        </select>
      </div>
      <div style="margin-top:6px"><label><input type="checkbox" class="checkbox ts-check" data-id="${id}"/> Verified</label></div>
      <input class="input-field ts-notes" data-id="${id}" placeholder="Notes (bins, modular, safety, etc.)" style="margin-top:6px"/>
    </div>`;
  [...topA,...topB].forEach(id=>grid.insertAdjacentHTML('beforeend', makeCard(id)));
  $$('.ts-check').forEach(c=>c.onchange=updateTopstockProgress);
  $$('.ts-status').forEach(s=>s.onchange=updateTopstockProgress);
  updateTopstockProgress();
}
function updateTopstockProgress(){
  const checks=$$('.ts-check'); const total=checks.length; const verified=checks.filter(c=>c.checked).length;
  const pct=Math.round((verified/total)*100)||0; $('#topstock-progress').style.width=pct+'%'; $('#topstock-progress').textContent=pct+'% Verified';
}
function markTopstockAll(val){ $$('.ts-check').forEach(c=>c.checked=val); updateTopstockProgress() }
function exportTopstockCSV(){
  const ids=[...topA,...topB]; const headers=['Aisle','Verified','Status','Notes'];
  const rows=ids.map(id=>{ const v=Boolean(document.querySelector(`.ts-check[data-id="${id}"]`)?.checked); const st=document.querySelector(`.ts-status[data-id="${id}"]`)?.value||''; const note=document.querySelector(`.ts-notes[data-id="${id}"]`)?.value||''; return [id,v?'Yes':'No',st,note]; });
  const csv=[headers.join(',')].concat(rows.map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','))).join('\n'); download('topstock.csv',csv);
}

/* ===== Charts (placeholder simple) ===== */
function drawCharts(){ /* No external libs; left as placeholder for now */ }

/* ===== Snapshot / Restore ===== */
function snapshot(){
  const prefs = loadLocal('wm_prefs', {});
  const deptTargets = loadLocal('wm_dept_targets', {});
  const freight=[...$('#freight-tbody').rows].map(r=>({assoc:$('.assoc',r).value,dept:$('.dept',r).value,cin:$('.cin',r).value,cout:$('.cout',r).value,cases:Number($('.cases',r).value||0)}));
  // zones
  const zones=[...$('#zone-tbody').rows].map(r=>{
    const zone=r.cells[0].innerText.trim(); const total=Number(r.cells[1].innerText.trim());
    const compCell=r.cells[2]; const val=(compCell.querySelector('.zcount')?.value) ?? (compCell.querySelector('.zdone')?.checked ? 1 : 0);
    return {zone,total,val};
  });
  // tours
  const tours=[...$('#tours-tbody').rows].map(r=>({slot:r.cells[0].innerText.trim(),target:r.cells[1].innerText.trim(),actual:$('.t-actual',r).value||'',checks:$$('.tck',r).map(c=>c.checked),temp:r.cells[9].querySelector('input').value||''}));
  // overstock
  const overstock=[...$('#overstock-tbody').rows].map(r=>({loc:$('.loc',r).value,upc:$('.upc',r).value,qty:Number($('.qty',r).value||0),action:$('.action',r).value,status:(r.cells[4].querySelector('span')?.innerText || $('.status',r)?.value || '')}));
  // topstock
  const topstock=[...topA,...topB].map(id=>({id,ver:document.querySelector(`.ts-check[data-id="${id}"]`)?.checked||false,status:document.querySelector(`.ts-status[data-id="${id}"]`)?.value||'',notes:document.querySelector(`.ts-notes[data-id="${id}"]`)?.value||''}));
  const coaching=loadLocal('coach_entries',[]);
  return {prefs,deptTargets,freight,zones,tours,overstock,topstock,coaching};
}
function restore(state){
  // prefs
  if(state?.prefs) saveLocal('wm_prefs', state.prefs);
  if(state?.deptTargets) saveLocal('wm_dept_targets', state.deptTargets);
  renderDeptTargets();
  // freight
  $('#freight-tbody').innerHTML=''; (state?.freight||[{},{},{}]).forEach(()=>addFreightRow());
  (state?.freight||[]).forEach((row,i)=>{const tr=$('#freight-tbody').rows[i]; if(!tr) return; $('.assoc',tr).value=row.assoc||''; $('.dept',tr).value=row.dept||departments[0]; $('.cin',tr).value=row.cin||''; $('.cout',tr).value=row.cout||''; $('.cases',tr).value=row.cases||0; });
  recalcFreight();
  // zones
  initZones();
  if(state?.zones){ state.zones.forEach((z,i)=>{const tr=$('#zone-tbody').rows[i]; if(!tr) return; const inp=tr.cells[2].querySelector('.zcount'); const chk=tr.cells[2].querySelector('.zdone'); if(inp){inp.value=z.val; updateZoneRow(inp);} if(chk){chk.checked=Boolean(z.val); updateZoneRow(chk);} }); }
  // tours
  initTours();
  if(state?.tours){ state.tours.forEach((t,i)=>{const tr=$('#tours-tbody').rows[i]; if(!tr) return; $('.t-actual',tr).value=t.actual||''; const cks=$$('.tck',tr); (t.checks||[]).forEach((v,ix)=>{ if(cks[ix]) cks[ix].checked=!!v; }); tr.cells[9].querySelector('input').value=t.temp||''; updateTourRow($('.t-actual',tr)); }); }
  // overstock
  $('#overstock-tbody').innerHTML=''; (state?.overstock||[{},{},{}]).forEach(()=>addOverstockRow());
  (state?.overstock||[]).forEach((o,i)=>{const tr=$('#overstock-tbody').rows[i]; if(!tr) return; $('.loc',tr).value=o.loc||''; $('.upc',tr).value=o.upc||''; $('.qty',tr).value=o.qty||0; $('.action',tr).value=o.action||'Binned'; tr.cells[4].innerHTML=`<span class="status-badge ${o.status==='Done'?'status-excellent':(o.status==='In Progress'?'status-good':'status-danger')}">${o.status||'Pending'}</span>`;});
  // coaching
  if(state?.coaching) saveLocal('coach_entries', state.coaching); renderCoachingList();
  // topstock
  initTopstock();
  if(state?.topstock){ state.topstock.forEach(ts=>{ const c=document.querySelector(`.ts-check[data-id="${ts.id}"]`); if(c) c.checked=!!ts.ver; const s=document.querySelector(`.ts-status[data-id="${ts.id}"]`); if(s) s.value=ts.status||''; const n=document.querySelector(`.ts-notes[data-id="${ts.id}"]`); if(n) n.value=ts.notes||''; }); updateTopstockProgress(); }
}

/* ===== Save / Load / Export / Clear / Print ===== */
function storageAvailable(){
  try{ const x='__wm_test__'; localStorage.setItem(x,'1'); localStorage.removeItem(x); return true; }catch(e){ return false; }
}
function initStorageButtons(){
  const saveBtn=$('#saveBtn'), loadBtn=$('#loadBtn'), exportBtn=$('#exportBtn'), clearBtn=$('#clearBtn'), printBtn=$('#printBtn');
  const importInput=document.createElement('input'); importInput.type='file'; importInput.accept='application/json'; importInput.style.display='none'; document.body.appendChild(importInput);
  saveBtn.onclick=()=>{
    try{
      const state=snapshot();
      if(storageAvailable()){ saveLocal('wm_dashboard_state', state); toast('Saved to this device'); }
      else{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='wm_dashboard_state_backup.json'; document.body.appendChild(a); a.click(); a.remove(); toast('Downloaded backup JSON'); }
    }catch(e){ alert('Save failed: '+e.message); }
  };
  loadBtn.onclick=()=>{
    try{
      if(storageAvailable()){
        const raw=localStorage.getItem('wm_dashboard_state');
        if(raw){ restore(JSON.parse(raw)); toast('Loaded saved state'); return; }
      }
      importInput.onchange=function(){ const f=this.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ restore(JSON.parse(r.result)); toast('Loaded from file'); }catch(e){ alert('Invalid backup file.'); } }; r.readAsText(f); };
      importInput.click();
    }catch(e){ alert('Load failed: '+e.message); }
  };
  exportBtn.onclick=()=>{ exportTableCSV('freight'); exportTableCSV('overstock'); exportZonesCSV(); exportToursCSV(); exportTopstockCSV(); };
  clearBtn.onclick=()=>{ if(confirm('Clear all tables (does not delete coaching)?')){ localStorage.removeItem('wm_dashboard_state'); restore({}); toast('Cleared'); } };
  printBtn.onclick=()=>{ window.print(); };
}

/* ===== Init ===== */
function init(){
  initHeader(); initTabs(); renderDeptTargets(); addFreightRow(); addFreightRow(); addFreightRow(); recalcFreight(); initZones(); initTours(); initStorageButtons(); initTopstock(); renderCoachingList();
  const state=loadLocal('wm_dashboard_state', null); if(state) restore(state);
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>